<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridDB - WebGPU Database Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #EDEDED; 
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .outfit { font-family: 'Outfit', sans-serif; }
        
        /* Dribbble-style Glow Effect */
        .glow-border {
            border: 1px solid rgba(52, 178, 123, 0.2);
            box-shadow: 0 0 15px rgba(52, 178, 123, 0.05);
        }
        .glow-text {
            text-shadow: 0 0 8px rgba(52, 178, 123, 0.6);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #1E293B; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #34B27B; }
        
        /* Scrollbar for column analysis */
        #columns-panel::-webkit-scrollbar { width: 4px; }
        #columns-panel::-webkit-scrollbar-track { background: transparent; }
        #columns-panel::-webkit-scrollbar-thumb { background: #34B27B/30; border-radius: 10px; }
        #columns-panel::-webkit-scrollbar-thumb:hover { background: #34B27B; }
        
        /* Terminal text glow */
        .terminal-text {
            color: #34B27B;
            text-shadow: 0 0 5px rgba(52, 178, 123, 0.4);
        }
        
        /* Noise texture overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><filter id="n"><feTurbulence baseFrequency="0.9"/></filter><rect width="300" height="300" filter="url(%23n)" opacity="0.05"/></svg>');
            opacity: 0.03;
            pointer-events: none;
            z-index: 999;
        }
        
        /* Smooth button states */
        button:active { transform: scale(0.98); }
        
        /* Pulsing animation for status */
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px #34B27B; }
            50% { opacity: 0.5; box-shadow: 0 0 20px #34B27B; }
        }
        .status-pulse { animation: pulse-glow 2s ease-in-out infinite; }
        
        /* Pulse animation for drag targets */
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 15px rgba(52, 178, 123, 0.6);
            }
            50% { 
                transform: scale(1.02); 
                box-shadow: 0 0 25px rgba(52, 178, 123, 0.8);
            }
        }
        
        /* Table hover effect */
        .table-row:hover {
            background: rgba(52, 178, 123, 0.05);
            border-left: 2px solid #34B27B;
        }
        
        /* Query editor styling */
        .query-editor {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(52, 178, 123, 0.1);
        }
        .query-editor:focus {
            outline: none;
            border-color: rgba(52, 178, 123, 0.3);
            box-shadow: 0 0 20px rgba(52, 178, 123, 0.1);
        }
        
        /* VS Code-style resizable panels */
        .resize-handle {
            position: relative;
            background: transparent;
            cursor: col-resize;
            user-select: none;
            z-index: 10;
            flex-shrink: 0;
        }
        .resize-handle:hover::after,
        .resize-handle.resizing::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: rgba(52, 178, 123, 0.5);
            transition: background 0.2s;
        }
        .resize-handle-horizontal {
            cursor: row-resize;
            height: 8px;
            flex-shrink: 0;
        }
        .resize-handle-horizontal:hover::after,
        .resize-handle-horizontal.resizing::after {
            width: 100%;
            height: 4px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        /* Panel collapse */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            border-radius: 0.75rem 0.75rem 0 0;
        }
        .panel-header:hover {
            background: rgba(52, 178, 123, 0.05);
        }
        .collapse-btn {
            transition: all 0.3s ease;
            font-size: 14px;
            padding: 4px;
            opacity: 0.5;
        }
        .panel-header:hover .collapse-btn {
            color: rgba(52, 178, 123, 0.8);
            opacity: 1;
        }
        
        /* Collapsed state */
        .panel-collapsed .collapse-btn {
            transform: rotate(-90deg);
        }
        
        .panel-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .panel-collapsed .panel-content {
            max-height: 0 !important;
            opacity: 0;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Column selection styles */
        .column-selectable {
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
        }
        
        .column-selectable:active {
            cursor: grabbing;
        }
        
        .column-selectable.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .column-selectable:hover {
            background: rgba(52, 178, 123, 0.15) !important;
            transform: translateY(-1px);
        }
        
        .column-selected {
            background: rgba(52, 178, 123, 0.25) !important;
            border-bottom: 3px solid #34B27B !important;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(52, 178, 123, 0.3);
        }
        
        /* Drag feedback */
        .drag-over {
            background: rgba(52, 178, 123, 0.2) !important;
            border-color: #34B27B !important;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(52, 178, 123, 0.4);
        }
        
        /* Cell selection */
        .cell-clickable {
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .cell-clickable:hover {
            background: rgba(52, 178, 123, 0.08);
        }
        
        /* Visualization menu */
        .viz-menu {
            position: fixed;
            background: linear-gradient(135deg, #11181C 0%, #1a2632 100%);
            border: 1px solid rgba(52, 178, 123, 0.4);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 30px rgba(52, 178, 123, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            z-index: 1000;
            min-width: 240px;
            animation: vizMenuSlideIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
        }
        
        @keyframes vizMenuSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-15px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .viz-menu-header {
            font-size: 14px;
            text-transform: uppercase;
            font-weight: bold;
            color: rgba(52, 178, 123, 0.8);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(52, 178, 123, 0.2);
            letter-spacing: 1px;
        }
        
        .viz-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #EDEDED;
            margin-bottom: 4px;
        }
        
        .viz-option:hover {
            background: rgba(52, 178, 123, 0.2);
            transform: translateX(4px);
            box-shadow: 0 0 10px rgba(52, 178, 123, 0.2);
        }
        
        .viz-option-icon {
            font-size: 20px;
            min-width: 20px;
            text-align: center;
        }
        
        .viz-option-label {
            flex: 1;
            font-weight: 600;
        }
        
        .viz-option-badge {
            font-size: 12px;
            background: rgba(52, 178, 123, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #34B27B;
            font-weight: bold;
        }
        
        .viz-option-recommended {
            border: 1px solid rgba(52, 178, 123, 0.4);
            background: rgba(52, 178, 123, 0.1);
        }
        
        /* Visualization modal */
        .viz-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .viz-modal-content {
            background: #11181C;
            border: 1px solid rgba(52, 178, 123, 0.3);
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 30px 90px rgba(0, 0, 0, 0.9);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Column info badge */
        .column-info-badge {
            font-size: 12px;
            background: rgba(52, 178, 123, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            color: rgba(52, 178, 123, 0.9);
        }

        /* Visualization Panel Styles */
        .viz-column-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: move;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .viz-column-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(52, 178, 123, 0.5);
            transform: translateX(2px);
        }

        .viz-graph-option {
            transition: all 0.2s ease;
        }

        .viz-graph-option:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(52, 178, 123, 0.2);
        }

        .viz-graph-selected {
            background: rgba(52, 178, 123, 0.2) !important;
            border-color: rgba(52, 178, 123, 0.8) !important;
        }

        .viz-selected-indicator {
            font-size: 18px;
            animation: checkBounce 0.4s ease;
        }

        @keyframes checkBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .viz-graph-disabled {
            opacity: 0.3;
            pointer-events: none;
            cursor: not-allowed;
        }

        .axis-picker-option {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2px;
        }

        .axis-picker-option:hover {
            background: rgba(52, 178, 123, 0.2);
            color: white;
        }

        /* Drag and drop visual feedback */
        [draggable="true"] {
            cursor: move;
        }

        .drop-zone-active {
            background: rgba(52, 178, 123, 0.1) !important;
            border-color: #34B27B !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-[#0a0a0a]">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-[#34B27B] rounded-lg flex items-center justify-center overflow-hidden p-1">
                <img src="../dbImage.png" alt="GridDB" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'font-bold text-black outfit\'>G</span>';">
            </div>
            <h1 class="outfit font-bold tracking-tight text-2xl">GridDB</h1>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-sm text-white/40">
                <span class="mono">Device:</span>
                <span class="text-white/70" id="gpu-name">Detecting...</span>
            </div>
            <div class="flex items-center gap-4 bg-[#111] px-3 py-1.5 rounded-full border border-white/5">
                <div class="w-2 h-2 bg-[#34B27B] rounded-full status-pulse"></div>
                <span class="text-sm font-semibold text-[#34B27B] uppercase tracking-widest glow-text" id="status-text">WebGPU: Ready </span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden p-4 gap-0">
        
        <!-- Left Sidebar -->
        <aside id="leftPanel" class="flex flex-col gap-4 overflow-y-auto max-h-full transition-all" style="width: 320px; min-width: 200px; max-width: 600px;">
            
            <!-- Import Dataset -->
            <section class="bg-[#11181C] rounded-xl border border-white/5 glow-border">
                <div class="panel-header p-4 rounded-t-xl" onclick="togglePanel('import')">
                    <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">Import Dataset</h2>
                    <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                </div>
                <div id="import-panel" class="panel-content p-4 pt-0">
                    <div id="dropzone" class="border-2 border-dashed border-white/10 rounded-xl h-32 flex flex-col items-center justify-center hover:border-[#34B27B]/50 transition-all cursor-pointer group">
                        <span class="text-2xl mb-2">üìÅ</span>
                        <p class="text-[10px] text-white/40 group-hover:text-[#34B27B] transition-colors uppercase font-bold">Drop CSV or JSON</p>
                        <input type="file" id="fileInput" accept=".csv,.json" style="display: none;">
                    </div>
                    <div id="loadProgress" class="mt-3 hidden">
                        <div class="bg-white/5 rounded-full h-3 overflow-hidden mb-2">
                            <div id="loadProgressBar" class="bg-gradient-to-r from-[#34B27B] to-[#2d9a68] h-full transition-all duration-300 flex items-center justify-end" style="width: 0%">
                                <span id="loadProgressPercent" class="text-[8px] font-bold text-black pr-2"></span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <p id="loadProgressText" class="text-[9px] text-white/40">Loading...</p>
                            <p id="loadProgressSize" class="text-[9px] text-[#34B27B] font-bold mono"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Database Stats -->
            <section class="bg-[#11181C] rounded-xl border border-white/5 glow-border">
                <div class="panel-header p-4 rounded-t-xl" onclick="togglePanel('stats')">
                    <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">Database Stats</h2>
                    <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                </div>
                <div id="stats-panel" class="panel-content p-4 pt-0 space-y-3">
                    <div>
                        <span class="text-[9px] text-white/30 uppercase block">Total Rows:</span>
                        <span class="text-xl font-bold text-[#34B27B] mono" id="total-rows">0</span>
                    </div>
                    <div>
                        <span class="text-[9px] text-white/30 uppercase block">GPU Memory:</span>
                        <span class="text-base font-semibold text-white/70 mono" id="gpu-memory">0 MB</span>
                    </div>
                    <div>
                        <span class="text-[9px] text-white/30 uppercase block">Cache Hit Rate:</span>
                        <span class="text-base font-semibold text-white/70 mono" id="cache-rate">0%</span>
                    </div>
                </div>
            </section>

            <!-- Visualization Panel -->
            <section class="bg-[#11181C] rounded-xl border border-white/5 glow-border">
                <div class="panel-header p-4 rounded-t-xl" onclick="togglePanel('visualization')">
                    <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">Visualization</h2>
                    <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                </div>
                <div id="visualization-panel" class="panel-content p-4 pt-0 space-y-3">
                    
                    <!-- Drag and Drop Hint -->
                    <div class="bg-[#34B27B]/10 border border-[#34B27B]/20 rounded-lg p-3 text-[10px] text-white/60">
                        <div class="flex items-start gap-2">
                            <span class="text-base">üí°</span>
                            <div>
                                <strong class="text-[#34B27B]">Quick Tip:</strong> 
                                <span class="text-white/50">Drag column headers from the table directly onto the X/Y/Z axis slots below!</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selected Columns -->
                    <div>
                        <span class="text-[9px] text-white/30 uppercase block mb-2">Selected Columns</span>
                        <div id="viz-selected-columns" class="space-y-1 min-h-[40px] bg-white/5 rounded-lg p-2 border border-dashed border-white/10">
                            <p class="text-[10px] text-white/20 text-center py-2">Click or drag columns from table above</p>
                        </div>
                    </div>

                    <!-- Axis Assignment -->
                    <div class="space-y-2">
                        <span class="text-[9px] text-white/30 uppercase block">Axis Assignment</span>
                        
                        <!-- X Axis -->
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-white/40 w-12">X:</span>
                            <div id="viz-x-axis" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1.5 text-[10px] text-white/50 hover:border-[#34B27B]/30 transition-all cursor-pointer min-h-[28px] flex items-center">
                                <span class="text-white/20">Drop column here</span>
                            </div>
                        </div>

                        <!-- Y Axis -->
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-white/40 w-12">Y:</span>
                            <div id="viz-y-axis" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1.5 text-[10px] text-white/50 hover:border-[#34B27B]/30 transition-all cursor-pointer min-h-[28px] flex items-center">
                                <span class="text-white/20">Drop column here</span>
                            </div>
                        </div>

                        <!-- Z Axis (Optional) -->
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-white/40 w-12">Z:</span>
                            <div id="viz-z-axis" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1.5 text-[10px] text-white/50 hover:border-[#34B27B]/30 transition-all cursor-pointer min-h-[28px] flex items-center">
                                <span class="text-white/20 italic">Optional (3D only)</span>
                            </div>
                        </div>

                        <!-- Color (Optional) -->
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-white/40 w-12">Color:</span>
                            <div id="viz-color-axis" class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1.5 text-[10px] text-white/50 hover:border-[#34B27B]/30 transition-all cursor-pointer min-h-[28px] flex items-center">
                                <span class="text-white/20 italic">Optional</span>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Type Selector -->
                    <div>
                        <span class="text-[9px] text-white/30 uppercase block mb-2">Graph Type</span>
                        <div id="viz-graph-types" class="space-y-1 max-h-[300px] overflow-y-auto pr-1">
                            
                            <!-- 2D Scatter -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="2d-scatter">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg">üìà</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">2D Scatter Plot</div>
                                        <div class="text-xs text-white/40">X vs Y numeric</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- 3D Scatter -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="3d-scatter">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg"></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">3D Scatter Plot</div>
                                        <div class="text-xs text-white/40">X, Y, Z numeric</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- Bar Chart -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="bar">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg"></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">Bar Chart</div>
                                        <div class="text-xs text-white/40">Categories + values</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- Histogram -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="histogram">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg">üìâ</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">Histogram</div>
                                        <div class="text-xs text-white/40">Distribution (numeric)</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- Line Chart -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="line">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg">üìà</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">Line Chart</div>
                                        <div class="text-xs text-white/40">Trends over time</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- Pie Chart -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="pie">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg">ü•ß</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">Pie Chart</div>
                                        <div class="text-xs text-white/40">Proportions</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                            <!-- KPI Card -->
                            <div class="viz-graph-option bg-white/5 hover:bg-white/10 border border-white/10 hover:border-[#34B27B]/50 rounded-lg p-2 cursor-pointer transition-all" data-graph-type="kpi">
                                <div class="flex items-center gap-2">
                                    <div class="text-lg">üíπ</div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white/80">KPI Card</div>
                                        <div class="text-xs text-white/40">Statistics summary</div>
                                    </div>
                                    <div class="viz-selected-indicator hidden text-[#34B27B] text-sm">‚úì</div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Visualize Button -->
                    <button id="viz-visualize-btn" onclick="triggerVisualization()" disabled class="w-full bg-[#34B27B]/20 text-white/30 text-sm font-bold uppercase py-2.5 rounded-lg transition-all cursor-not-allowed">
                        <span>VISUALIZE</span>
                    </button>

                </div>
            </section>

            <!-- Column Analysis -->
            <section class="bg-[#11181C] rounded-xl border border-white/5 glow-border flex flex-col min-h-0 flex-1">
                <div class="panel-header p-4 rounded-t-xl flex-shrink-0" onclick="togglePanel('columns')">
                    <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">Column Analysis</h2>
                    <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                </div>
                <div id="columns-panel" class="panel-content flex-1 overflow-y-auto space-y-2 px-4 pb-4" style="max-height: 600px;">
                    <div class="text-center py-8">
                        <div class="text-3xl mb-2 opacity-30"></div>
                        <p class="text-white/30 text-sm">Load data to see column details</p>
                    </div>
                </div>
            </section>
        </aside>
        
        <!-- Resize Handle -->
        <div class="resize-handle w-2 hover:bg-white/5 cursor-col-resize" id="leftResizer"></div>

        <!-- Center Section -->
        <section class="flex-1 flex flex-col gap-4 overflow-hidden px-4" id="centerPanel">
            
            <!-- SQL Query Editor and Create Table Row -->
            <div class="flex gap-0 h-96" style="min-height: 200px;">
                <!-- SQL Query Editor -->
                <div class="flex-1 bg-[#11181C] rounded-xl border border-white/5 glow-border flex flex-col" id="queryPanel" style="min-width: 300px;">
                    <div class="panel-header p-4 rounded-t-xl" onclick="togglePanel('query')">
                        <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">SQL Query</h2>
                        <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                    </div>
                    <div id="query-panel" class="panel-content flex-1 flex flex-col p-4 pt-0">
                        <div class="flex gap-2 mb-3">
                            <button onclick="executeQuery()" class="bg-[#34B27B] hover:bg-[#2d9a68] text-black text-sm font-bold uppercase px-6 py-2 rounded-lg transition-all glow-border flex items-center gap-2">
                                <span>RUN QUERY</span>
                                <span>‚ñ∂</span>
                            </button>
                            <button onclick="clearQuery()" class="bg-white/5 hover:bg-white/10 text-white/70 text-sm font-bold uppercase px-4 py-2 rounded-lg transition-all">CLEAR</button>
                            
                            <!-- JOIN Dropdown Button -->
                            <div class="relative">
                                <button onclick="toggleJoinMenu()" id="joinBtn" class="bg-white/5 hover:bg-[#34B27B]/20 text-[#34B27B] text-sm font-bold uppercase px-4 py-2 rounded-lg transition-all border border-[#34B27B]/30 flex items-center gap-2">
                                    <span>‚ö° JOIN</span>
                                    <span>‚ñº</span>
                                </button>
                                
                                <!-- Dropdown Menu -->
                                <div id="joinMenu" class="hidden absolute top-full left-0 mt-1 bg-[#1a1a1a] border border-[#34B27B]/30 rounded-lg shadow-lg z-50 min-w-[180px]">
                                    <div class="p-1">
                                        <button onclick="insertJoin('INNER')" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-[#34B27B]/20 rounded transition-all flex items-center gap-2">
                                            <span class="text-[#34B27B]">‚ö°</span>
                                            <span>INNER JOIN</span>
                                        </button>
                                        <button onclick="insertJoin('LEFT')" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-[#34B27B]/20 rounded transition-all flex items-center gap-2">
                                            <span class="text-[#34B27B]">‚ö°</span>
                                            <span>LEFT JOIN</span>
                                        </button>
                                        <button onclick="insertJoin('RIGHT')" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-[#34B27B]/20 rounded transition-all flex items-center gap-2">
                                            <span class="text-[#34B27B]">‚ö°</span>
                                            <span>RIGHT JOIN</span>
                                        </button>
                                        <button onclick="insertJoin('FULL')" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-[#34B27B]/20 rounded transition-all flex items-center gap-2">
                                            <span class="text-[#34B27B]">‚ö°</span>
                                            <span>FULL JOIN</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <textarea 
                            id="queryInput" 
                            class="query-editor w-full flex-1 p-4 rounded-lg text-[#34B27B] mono text-sm resize-none min-h-[200px]"
                            placeholder="SELECT * FROM tablename LIMIT 100">SELECT * FROM export LIMIT 100</textarea>
                        
                        <div class="flex justify-between items-center mt-3 text-xs text-white/30">
                            <span class="mono">Execution: <span id="exec-time" class="text-[#34B27B]">0.000<span class="text-base ml-1 text-white/40 font-light">ms</span></span></span>
                            <span class="mono" id="speedup">GPU acceleration ready</span>
                        </div>
                        
                        <!-- Query Info/Notifications -->
                        <div id="queryInfo" class="mt-3"></div>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle w-2 hover:bg-white/5 cursor-col-resize mx-2" id="queryResizer"></div>

                <!-- Create Table (Smaller) -->
                <div class="bg-[#11181C] rounded-xl border border-white/5 glow-border flex flex-col" id="createPanel" style="width: 288px; min-width: 200px; max-width: 400px;">
                    <div class="panel-header p-4 rounded-t-xl" onclick="togglePanel('create')">
                        <h2 class="panel-title text-sm font-bold uppercase text-white/40 tracking-widest">Create Table</h2>
                        <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                    </div>
                    <div id="create-panel" class="panel-content p-4 pt-0 space-y-2">
                        <input 
                            type="text" 
                            id="newTableName" 
                            placeholder="Table name"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-white/30 focus:outline-none focus:border-[#34B27B]/50 transition-all"
                        />
                        <button onclick="showCreateTableModal()" class="w-full bg-[#34B27B] hover:bg-[#2d9a68] text-black text-[10px] font-bold uppercase py-2 rounded-lg transition-all glow-border">
                            ‚ûï CREATE
                        </button>
                        <div class="text-[8px] text-white/30 space-y-0.5 pt-1">
                            <p>‚ú® Define columns</p>
                            <p>Add data</p>
                            <p>GPU-powered</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resize Handle Horizontal -->
            <div class="resize-handle-horizontal h-2 hover:bg-white/5 cursor-row-resize" id="horizontalResizer"></div>

            <!-- Query Results Table -->
            <div class="flex-1 bg-[#11181C] rounded-xl border border-white/5 glow-border flex flex-col overflow-hidden" id="resultsPanel" style="min-height: 200px;">
                <div class="panel-header p-4 bg-white/5 border-b border-white/5 rounded-t-xl" onclick="togglePanel('results')">
                    <div class="flex justify-between items-center flex-wrap gap-2 w-full">
                        <div class="flex items-center gap-3">
                            <span class="panel-title text-[10px] font-bold uppercase text-white/40 tracking-widest">Query Results</span>
                            <span class="collapse-btn text-white/40 text-sm">‚ñº</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-[#34B27B] mono">Rows: <span id="result-count">0</span></span>
                            <button onclick="generateInsights()" class="text-[10px] bg-white/5 hover:bg-[#34B27B]/20 px-3 py-1 rounded text-white/60 hover:text-[#34B27B] font-bold transition-all">INSIGHTS</button>
                            <button onclick="showVisualization()" class="text-[10px] bg-white/5 hover:bg-[#34B27B]/20 px-3 py-1 rounded text-white/60 hover:text-[#34B27B] font-bold transition-all">VISUALIZE</button>
                            <button onclick="exportJSON()" class="text-[10px] bg-white/5 hover:bg-white/10 px-3 py-1 rounded text-white/60 font-bold transition-all">JSON</button>
                            <button onclick="exportResults()" class="text-[10px] bg-white/5 hover:bg-white/10 px-3 py-1 rounded text-white/60 font-bold transition-all">CSV</button>
                        </div>
                    </div>
                </div>
                <div id="results-panel" class="panel-content flex-1 overflow-y-auto" id="results-container">
                    <table class="w-full text-left mono text-[11px]">
                        <thead class="sticky top-0 bg-[#11181C] border-b border-white/10">
                            <tr class="text-white/40 uppercase" id="table-header">
                                <th class="p-4 font-bold">Load data to see results</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5" id="table-body">
                            <tr class="table-row hover:bg-white/5 transition-colors cursor-pointer text-white/70">
                                <td class="p-4 text-white/40">
                                    <div class="text-center py-8">
                                        <div class="text-4xl mb-2"></div>
                                        <p class="text-white/30 text-sm">Upload a CSV/JSON file or load sample data to begin</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Create Table Modal -->
    <div id="createTableModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-[#11181C] rounded-xl border border-white/5 glow-border p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white outfit">Create New Table</h2>
                <button onclick="closeCreateTableModal()" class="text-white/40 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-white/40 uppercase block mb-2">Table Name</label>
                    <input 
                        type="text" 
                        id="modalTableName" 
                        placeholder="users"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-base text-white placeholder-white/30 focus:outline-none focus:border-[#34B27B]/50"
                    />
                </div>
                
                <div>
                    <label class="text-sm text-white/40 uppercase block mb-2">Columns</label>
                    <div id="columnsList" class="space-y-2 mb-2">
                        <!-- Column rows will be added here -->
                    </div>
                    <button onclick="addColumnRow()" class="text-[10px] bg-white/5 hover:bg-white/10 text-white/70 px-3 py-1.5 rounded font-bold transition-all">
                        ‚ûï Add Column
                    </button>
                </div>
                
                <div>
                    <label class="text-sm text-white/40 uppercase block mb-2">Initial Data (Optional - JSON Array)</label>
                    <textarea 
                        id="initialData" 
                        placeholder='[{"id": 1, "name": "Alice"}, {"id": 2, "name": "Bob"}]'
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white placeholder-white/30 focus:outline-none focus:border-[#34B27B]/50 mono h-32 resize-none"
                    ></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="createNewTable()" class="flex-1 bg-[#34B27B] hover:bg-[#2d9a68] text-black text-xs font-bold uppercase py-3 rounded-lg transition-all">
                        Create Table
                    </button>
                    <button onclick="closeCreateTableModal()" class="flex-1 bg-white/5 hover:bg-white/10 text-white/70 text-xs font-bold uppercase py-3 rounded-lg transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GridDB, formatResultsHTML, formatResultsASCII, computeStats } from './griddb.mjs';
        let db;
        let device;
        let currentTable = null;
        let lastResults = null;
        let webgpuViz = null;
        
        /**
         * WebGL Visualization Engine
         * Renders 2D/3D scatter, bar, line, histogram using WebGL
         * Can handle MILLIONS of points efficiently via GPU
         */
        class WebGPUViz {
            constructor(device) {
                this.device = device;
                this.initialized = false;
                this.gl = null;
                this.shaderPrograms = {};
            }

            async init() {
                console.log('WebGL Visualization Engine initialized');
                this.initialized = true;
            }

            /**
             * Initialize WebGL context and shaders
             */
            initWebGL(canvas) {
                if (this.gl) return this.gl;

                const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
                if (!gl) {
                    throw new Error('WebGL not supported');
                }

                this.gl = gl;

                // Create shader program for point rendering
                this.shaderPrograms.points = this.createPointShaderProgram(gl);
                this.shaderPrograms.lines = this.createLineShaderProgram(gl);
                this.shaderPrograms.bars = this.createBarShaderProgram(gl);

                console.log('‚úÖ WebGL initialized successfully');
                return gl;
            }

            /**
             * Create shader program for point rendering (scatter plots)
             */
            createPointShaderProgram(gl) {
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec3 a_color;
                    attribute float a_size;
                    
                    uniform vec2 u_resolution;
                    uniform vec4 u_bounds; // xMin, xMax, yMin, yMax
                    
                    varying vec3 v_color;
                    
                    void main() {
                        // Normalize position to 0-1 range
                        vec2 normalized = (a_position - u_bounds.xy) / (u_bounds.zw - u_bounds.xy);
                        
                        // Convert to clip space (-1 to 1)
                        vec2 clipSpace = normalized * 2.0 - 1.0;
                        clipSpace.y = -clipSpace.y; // Flip Y axis
                        
                        gl_Position = vec4(clipSpace, 0.0, 1.0);
                        gl_PointSize = a_size;
                        v_color = a_color;
                    }
                `;

                const fragmentShaderSource = `
                    precision mediump float;
                    varying vec3 v_color;
                    
                    void main() {
                        // Make points circular
                        vec2 coord = gl_PointCoord - vec2(0.5);
                        float dist = length(coord);
                        if (dist > 0.5) discard;
                        
                        // Anti-aliasing
                        float alpha = smoothstep(0.5, 0.4, dist);
                        gl_FragColor = vec4(v_color, alpha * 0.8);
                    }
                `;

                return this.compileShaderProgram(gl, vertexShaderSource, fragmentShaderSource);
            }

            /**
             * Create shader program for line rendering (line charts)
             */
            createLineShaderProgram(gl) {
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    uniform vec2 u_resolution;
                    uniform vec4 u_bounds;
                    
                    void main() {
                        vec2 normalized = (a_position - u_bounds.xy) / (u_bounds.zw - u_bounds.xy);
                        vec2 clipSpace = normalized * 2.0 - 1.0;
                        clipSpace.y = -clipSpace.y;
                        gl_Position = vec4(clipSpace, 0.0, 1.0);
                    }
                `;

                const fragmentShaderSource = `
                    precision mediump float;
                    uniform vec3 u_color;
                    
                    void main() {
                        gl_FragColor = vec4(u_color, 0.9);
                    }
                `;

                return this.compileShaderProgram(gl, vertexShaderSource, fragmentShaderSource);
            }

            /**
             * Create shader program for bar rendering
             */
            createBarShaderProgram(gl) {
                const vertexShaderSource = `
                    attribute vec2 a_position;
                    attribute vec3 a_color;
                    
                    uniform vec2 u_resolution;
                    
                    varying vec3 v_color;
                    
                    void main() {
                        vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
                        clipSpace.y = -clipSpace.y;
                        gl_Position = vec4(clipSpace, 0.0, 1.0);
                        v_color = a_color;
                    }
                `;

                const fragmentShaderSource = `
                    precision mediump float;
                    varying vec3 v_color;
                    
                    void main() {
                        gl_FragColor = vec4(v_color, 0.85);
                    }
                `;

                return this.compileShaderProgram(gl, vertexShaderSource, fragmentShaderSource);
            }

            /**
             * Compile and link shader program
             */
            compileShaderProgram(gl, vertexSource, fragmentSource) {
                const vertexShader = this.compileShader(gl, gl.VERTEX_SHADER, vertexSource);
                const fragmentShader = this.compileShader(gl, gl.FRAGMENT_SHADER, fragmentSource);

                const program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);

                if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                    throw new Error('Shader program linking failed: ' + gl.getProgramInfoLog(program));
                }

                return program;
            }

            /**
             * Compile individual shader
             */
            compileShader(gl, type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);

                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    throw new Error('Shader compilation failed: ' + gl.getShaderInfoLog(shader));
                }

                return shader;
            }

            /**
             * Render 2D Scatter Plot with WebGL
             * Can handle MILLIONS of points efficiently
             */
            async render2DScatter(canvas, data, xColumn, yColumn, colorColumn = null) {
                const startTime = performance.now();
                const gl = this.initWebGL(canvas);
                
                console.log(` WebGL Rendering ${data.length} points: X="${xColumn}", Y="${yColumn}"`);

                // Extract and prepare data
                const points = [];
                const colors = [];
                const sizes = [];
                
                let xMin = Infinity, xMax = -Infinity;
                let yMin = Infinity, yMax = -Infinity;

                data.forEach((row, idx) => {
                    const x = parseFloat(row[xColumn]);
                    const y = parseFloat(row[yColumn]);

                    if (isNaN(x) || isNaN(y)) return;

                    points.push(x, y);
                    
                    xMin = Math.min(xMin, x);
                    xMax = Math.max(xMax, x);
                    yMin = Math.min(yMin, y);
                    yMax = Math.max(yMax, y);

                    // Color based on index or color column
                    const hue = colorColumn ? (idx / data.length) * 360 : 200;
                    const rgb = this.hslToRgb(hue, 70, 60);
                    colors.push(rgb[0], rgb[1], rgb[2]);
                    
                    sizes.push(6.0); // Point size
                });

                if (points.length === 0) {
                    this.renderNoData(canvas);
                    return;
                }

                // Clear and setup
                gl.viewport(0, 0, canvas.width, canvas.height);
                gl.clearColor(0.04, 0.04, 0.04, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                
                // Enable blending for transparency
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                // Use shader program
                const program = this.shaderPrograms.points;
                gl.useProgram(program);

                // Create and bind buffers
                const positionBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(points), gl.STATIC_DRAW);

                const positionLoc = gl.getAttribLocation(program, 'a_position');
                gl.enableVertexAttribArray(positionLoc);
                gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);

                // Color buffer
                const colorBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);

                const colorLoc = gl.getAttribLocation(program, 'a_color');
                gl.enableVertexAttribArray(colorLoc);
                gl.vertexAttribPointer(colorLoc, 3, gl.FLOAT, false, 0, 0);

                // Size buffer
                const sizeBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, sizeBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(sizes), gl.STATIC_DRAW);

                const sizeLoc = gl.getAttribLocation(program, 'a_size');
                gl.enableVertexAttribArray(sizeLoc);
                gl.vertexAttribPointer(sizeLoc, 1, gl.FLOAT, false, 0, 0);

                // Set uniforms
                const resolutionLoc = gl.getUniformLocation(program, 'u_resolution');
                gl.uniform2f(resolutionLoc, canvas.width, canvas.height);

                const boundsLoc = gl.getUniformLocation(program, 'u_bounds');
                gl.uniform4f(boundsLoc, xMin, xMax, yMin, yMax);

                // Draw all points in ONE call (GPU magic!)
                gl.drawArrays(gl.POINTS, 0, points.length / 2);

                // Draw axes using Canvas 2D overlay
                this.drawAxes2D(canvas, xColumn, yColumn, xMin, xMax, yMin, yMax);

                const elapsed = (performance.now() - startTime).toFixed(2);
                console.log(` WebGL rendered ${points.length / 2} points in ${elapsed}ms`);
            }

            /**
             * Render Bar Chart with WebGL
             * Perfect for categorical data visualization
             */
            async renderBarChart(canvas, data, xColumn, yColumn) {
                const startTime = performance.now();
                const gl = this.initWebGL(canvas);
                
                console.log(` WebGL Bar Chart: ${data.length} categories`);

                // Aggregate data by category
                const categoryMap = new Map();
                data.forEach(row => {
                    const category = String(row[xColumn]);
                    const value = parseFloat(row[yColumn]);
                    
                    if (!isNaN(value)) {
                        if (!categoryMap.has(category)) {
                            categoryMap.set(category, { sum: 0, count: 0 });
                        }
                        const stats = categoryMap.get(category);
                        stats.sum += value;
                        stats.count += 1;
                    }
                });

                const categories = Array.from(categoryMap.keys());
                const values = categories.map(cat => categoryMap.get(cat).sum / categoryMap.get(cat).count);
                
                if (values.length === 0) {
                    this.renderNoData(canvas);
                    return;
                }

                const maxValue = Math.max(...values);
                const padding = 60;
                const width = canvas.width;
                const height = canvas.height;
                const plotHeight = height - padding * 2;
                const plotWidth = width - padding * 2;
                const barWidth = plotWidth / categories.length;

                // Create vertex data for bars
                const vertices = [];
                const colors = [];

                categories.forEach((cat, idx) => {
                    const value = values[idx];
                    const barHeight = (value / maxValue) * plotHeight;
                    const x = padding + idx * barWidth;
                    const y = height - padding - barHeight;

                    // Two triangles per bar (rectangle)
                    vertices.push(
                        x, height - padding,
                        x + barWidth * 0.8, height - padding,
                        x + barWidth * 0.8, y,
                        
                        x, height - padding,
                        x + barWidth * 0.8, y,
                        x, y
                    );

                    // Color gradient based on value
                    const hue = (idx / categories.length) * 360;
                    const rgb = this.hslToRgb(hue, 70, 60);
                    for (let i = 0; i < 6; i++) {
                        colors.push(rgb[0], rgb[1], rgb[2]);
                    }
                });

                // Clear and setup
                gl.viewport(0, 0, width, height);
                gl.clearColor(0.04, 0.04, 0.04, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                // Use shader program
                const program = this.shaderPrograms.bars;
                gl.useProgram(program);

                // Position buffer
                const positionBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);

                const positionLoc = gl.getAttribLocation(program, 'a_position');
                gl.enableVertexAttribArray(positionLoc);
                gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);

                // Color buffer
                const colorBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);

                const colorLoc = gl.getAttribLocation(program, 'a_color');
                gl.enableVertexAttribArray(colorLoc);
                gl.vertexAttribPointer(colorLoc, 3, gl.FLOAT, false, 0, 0);

                // Set uniforms
                const resolutionLoc = gl.getUniformLocation(program, 'u_resolution');
                gl.uniform2f(resolutionLoc, width, height);

                // Draw all bars
                gl.drawArrays(gl.TRIANGLES, 0, vertices.length / 2);

                // Draw labels with Canvas 2D
                this.drawBarLabels(canvas, categories, values, maxValue);

                const elapsed = (performance.now() - startTime).toFixed(2);
                console.log(` WebGL bar chart rendered in ${elapsed}ms`);
            }

            /**
             * Render Histogram with WebGL
             * Shows distribution of numeric data
             */
            async renderHistogram(canvas, data, column, bins = 20) {
                const startTime = performance.now();
                
                // Extract numeric values
                const values = data.map(row => parseFloat(row[column])).filter(v => !isNaN(v));
                
                if (values.length === 0) {
                    this.renderNoData(canvas);
                    return;
                }

                const min = Math.min(...values);
                const max = Math.max(...values);
                const binSize = (max - min) / bins;

                // Create histogram bins
                const histogram = new Array(bins).fill(0);
                values.forEach(value => {
                    const binIndex = Math.min(Math.floor((value - min) / binSize), bins - 1);
                    histogram[binIndex]++;
                });

                const maxCount = Math.max(...histogram);
                
                // Render as bar chart
                const histData = histogram.map((count, idx) => ({
                    bin: (min + idx * binSize).toFixed(1),
                    count: count
                }));

                await this.renderBarChart(canvas, histData, 'bin', 'count');

                const elapsed = (performance.now() - startTime).toFixed(2);
                console.log(`‚úÖ Histogram rendered in ${elapsed}ms`);
            }

            /**
             * Render 3D Scatter Plot (WebGL + 3D projection)
             */
            async render3DScatter(canvas, data, options) {
                // For now, fallback to 2D rendering with z-coloring
                const { xColumn, yColumn, zColumn } = options;
                await this.render2DScatter(canvas, data, xColumn, yColumn, zColumn);
            }

            /**
             * Helper: HSL to RGB conversion
             */
            hslToRgb(h, s, l) {
                s /= 100;
                l /= 100;
                const c = (1 - Math.abs(2 * l - 1)) * s;
                const x = c * (1 - Math.abs((h / 60) % 2 - 1));
                const m = l - c / 2;
                let r, g, b;

                if (h < 60) { r = c; g = x; b = 0; }
                else if (h < 120) { r = x; g = c; b = 0; }
                else if (h < 180) { r = 0; g = c; b = x; }
                else if (h < 240) { r = 0; g = x; b = c; }
                else if (h < 300) { r = x; g = 0; b = c; }
                else { r = c; g = 0; b = x; }

                return [(r + m), (g + m), (b + m)];
            }

            /**
             * Helper: Draw axes overlay using Canvas 2D
             */
            drawAxes2D(canvas, xLabel, yLabel, xMin, xMax, yMin, yMax) {
                const ctx = canvas.getContext('2d', { alpha: true });
                const width = canvas.width;
                const height = canvas.height;
                const padding = 60;

                // Draw axis labels
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = 'bold 14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(xLabel, width / 2, height - 20);
                
                ctx.save();
                ctx.translate(20, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText(yLabel, 0, 0);
                ctx.restore();

                // Draw axis lines
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();

                // Draw ticks
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.font = '10px monospace';
                
                for (let i = 0; i <= 5; i++) {
                    const xValue = xMin + (xMax - xMin) * (i / 5);
                    const yValue = yMin + (yMax - yMin) * (i / 5);
                    
                    const x = padding + (width - 2 * padding) * (i / 5);
                    const y = height - padding - (height - 2 * padding) * (i / 5);
                    
                    ctx.textAlign = 'center';
                    ctx.fillText(xValue.toFixed(1), x, height - padding + 20);
                    
                    ctx.textAlign = 'right';
                    ctx.fillText(yValue.toFixed(1), padding - 10, y + 4);
                }
            }

            /**
             * Helper: Draw bar chart labels
             */
            drawBarLabels(canvas, categories, values, maxValue) {
                const ctx = canvas.getContext('2d', { alpha: true });
                const width = canvas.width;
                const height = canvas.height;
                const padding = 60;
                const barWidth = (width - 2 * padding) / categories.length;

                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';

                categories.forEach((cat, idx) => {
                    const x = padding + idx * barWidth + barWidth * 0.4;
                    ctx.save();
                    ctx.translate(x, height - padding + 15);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillText(String(cat).substring(0, 12), 0, 0);
                    ctx.restore();

                    // Value labels
                    const value = values[idx];
                    const barHeight = (value / maxValue) * (height - 2 * padding);
                    const y = height - padding - barHeight - 5;
                    ctx.fillText(value.toFixed(1), x, y);
                });

                // Y-axis label
                ctx.font = 'bold 12px Inter';
                ctx.save();
                ctx.translate(15, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Average Value', 0, 0);
                ctx.restore();
            }

            /**
             * Helper: Render "no data" message
             */
            renderNoData(canvas) {
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#fff';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No numeric data found', canvas.width / 2, canvas.height / 2);
            }
        }
        
        // ========================================
        // GLOBAL STATE
        // ========================================
        
        // Column selection state
        let selectedColumns = [];
        let columnDataTypes = new Map();
        let isMultiSelectMode = false;
        
        // Debounce timer for axis assignments
        let axisAssignmentDebounce = null;
        
        // Axis slots initialization state
        let axisSlotsInitialized = false;

        // Panel collapse/expand functionality
        const collapsedPanels = new Set();
        
        window.togglePanel = function(panelId) {
            const panel = document.getElementById(`${panelId}-panel`);
            if (!panel) return;
            
            const parentSection = panel.closest('section, div[id$="Panel"]');
            if (!parentSection) return;
            
            if (collapsedPanels.has(panelId)) {
                // Expand
                collapsedPanels.delete(panelId);
                parentSection.classList.remove('panel-collapsed');
                // Let CSS transition handle the animation
            } else {
                // Collapse
                collapsedPanels.add(panelId);
                parentSection.classList.add('panel-collapsed');
            }
        };

        // Resize functionality
        function initResizers() {
            const leftResizer = document.getElementById('leftResizer');
            const leftPanel = document.getElementById('leftPanel');
            
            const queryResizer = document.getElementById('queryResizer');
            const queryPanel = document.getElementById('queryPanel');
            const createPanel = document.getElementById('createPanel');
            
            const horizontalResizer = document.getElementById('horizontalResizer');
            
            if (!leftResizer || !queryResizer || !horizontalResizer) {
                console.warn('Resizers not found, retrying...');
                return;
            }
            
            // Left panel resizer (sidebar width)
            let isResizingLeft = false;
            let startX, startWidth;
            
            leftResizer.addEventListener('mousedown', (e) => {
                isResizingLeft = true;
                startX = e.clientX;
                startWidth = leftPanel.offsetWidth;
                leftResizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            // Query/Create panel resizer (horizontal split between query and create)
            let isResizingQuery = false;
            let queryStartX, queryStartWidth, createStartWidth;
            
            queryResizer.addEventListener('mousedown', (e) => {
                isResizingQuery = true;
                queryStartX = e.clientX;
                queryStartWidth = queryPanel.offsetWidth;
                createStartWidth = createPanel.offsetWidth;
                queryResizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            // Horizontal resizer (query row height vs results height)
            let isResizingHorizontal = false;
            let startY, queryRowStartHeight;
            
            horizontalResizer.addEventListener('mousedown', (e) => {
                isResizingHorizontal = true;
                startY = e.clientY;
                const queryRow = queryPanel.closest('.flex');
                queryRowStartHeight = queryRow.offsetHeight;
                horizontalResizer.classList.add('resizing');
                document.body.style.cursor = 'row-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            // Mouse move handler
            document.addEventListener('mousemove', (e) => {
                if (isResizingLeft) {
                    const delta = e.clientX - startX;
                    const newWidth = Math.max(200, Math.min(800, startWidth + delta));
                    leftPanel.style.width = `${newWidth}px`;
                } else if (isResizingQuery) {
                    const delta = e.clientX - queryStartX;
                    const newQueryWidth = Math.max(300, queryStartWidth + delta);
                    const newCreateWidth = Math.max(200, Math.min(500, createStartWidth - delta));
                    
                    // Only update if both panels stay within bounds
                    if (newCreateWidth >= 200 && newCreateWidth <= 500) {
                        queryPanel.style.flex = 'none';
                        queryPanel.style.width = `${newQueryWidth}px`;
                        createPanel.style.width = `${newCreateWidth}px`;
                    }
                } else if (isResizingHorizontal) {
                    const delta = e.clientY - startY;
                    const queryRow = queryPanel.closest('.flex');
                    const newQueryRowHeight = Math.max(150, Math.min(600, queryRowStartHeight + delta));
                    queryRow.style.height = `${newQueryRowHeight}px`;
                }
            });
            
            // Mouse up handler
            document.addEventListener('mouseup', () => {
                if (isResizingLeft || isResizingQuery || isResizingHorizontal) {
                    isResizingLeft = false;
                    isResizingQuery = false;
                    isResizingHorizontal = false;
                    leftResizer.classList.remove('resizing');
                    queryResizer.classList.remove('resizing');
                    horizontalResizer.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
            
            console.log('Resizers initialized');
        }
        
        // Initialize resizers when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initResizers);
            document.addEventListener('DOMContentLoaded', initGraphTypeSelector);
            document.addEventListener('DOMContentLoaded', updateAxisSlots);
        } else {
            initResizers();
            initGraphTypeSelector();
            updateAxisSlots();
        }
        // Also try after a delay as fallback
        setTimeout(initResizers, 100);
        setTimeout(initGraphTypeSelector, 100);
        setTimeout(updateAxisSlots, 100);

        // Initialize WebGPU and GridDB
        async function init() {
            try {
                if (!navigator.gpu) {
                    document.getElementById('status-text').textContent = 'WebGPU: Not Supported ';
                    document.getElementById('gpu-name').textContent = 'WebGPU not available';
                    console.error('WebGPU is not supported in this browser');
                    return;
                }

                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) throw new Error('Failed to get GPU adapter');
                
                // Check for subgroups support
                const requiredFeatures = [];
                if (adapter.features.has('subgroups')) {
                    requiredFeatures.push('subgroups');
                    console.log('‚úÖ Subgroups feature available');
                } else {
                    console.log('‚ö†Ô∏è Subgroups not available, using fallback');
                }
                
                device = await adapter.requestDevice({
                    requiredFeatures,
                    requiredLimits: {
                        maxBufferSize: 2147483648 / 2,
                        maxStorageBufferBindingSize: 2147483644 / 2,
                    },
                });
                
                const gpuInfo = adapter.info?.description || adapter.info?.vendor || 'Unknown GPU';
                document.getElementById('gpu-name').textContent = gpuInfo;
                
                db = new GridDB(device);
                console.log('GridDB initialized with device:', gpuInfo);
                
                // Initialize WebGPU Viz
                webgpuViz = new WebGPUViz(device);
                await webgpuViz.init();
                console.log('WebGPU Visualization engine ready');
                
                document.getElementById('status-text').textContent = 'WebGPU: Ready ';
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('status-text').textContent = 'WebGPU: Error ';
                document.getElementById('gpu-name').textContent = error.message;
            }
        }

        // Load sample data
        window.loadSampleData = async function() {
            if (!db) {
                showNotification('Database not initialized. Please wait for WebGPU to load.', 'error');
                return;
            }

            showProgress('Preparing sample data...', 20);

            const sampleData = [
                { id: 1, name: 'Alice Johnson', status: 'active', created_at: '2024-01-15', hardware: 'NVIDIA A100', vram: 32.4 },
                { id: 2, name: 'Bob Smith', status: 'active', created_at: '2024-02-20', hardware: 'RTX 4090', vram: 24.0 },
                { id: 3, name: 'Carol Davis', status: 'inactive', created_at: '2024-03-10', hardware: 'RTX 3090', vram: 24.0 },
                { id: 4, name: 'David Wilson', status: 'active', created_at: '2024-01-05', hardware: 'AMD MI250X', vram: 128.0 },
                { id: 5, name: 'Eve Martinez', status: 'active', created_at: '2024-02-14', hardware: 'RTX 4090', vram: 24.0 },
            ];

            try {
                showProgress('Loading data into GPU memory...', 50);
                
                if (db.tables.has('users')) db.tables.delete('users');
                await db.loadJSON('users', sampleData);
                currentTable = 'users';
                
                showProgress('Analyzing columns...', 80);
                
                document.getElementById('total-rows').textContent = sampleData.length.toLocaleString();
                updateStats();
                updateColumnAnalysis('users');
                
                // Generate suggested queries
                const table = db.tables.get('users');
                generateSuggestedQueries('users', table);
                
                showProgress('Complete!', 100);
                
                console.log('Sample data loaded: 5 rows');
                
                // Auto-display the data - load ALL rows for visualization
                const result = await db.query(`SELECT * FROM users`);
                lastResults = result; // Store ALL data for visualizations
                displayResults(result);
                
                setTimeout(() => {
                    hideProgress();
                    showNotification('Sample data loaded successfully! 5 rows ready for queries.', 'success');
                }, 500);
                
            } catch (error) {
                console.error('Error loading sample data:', error);
                hideProgress();
                showNotification('Error loading sample data: ' + error.message, 'error');
            }
        };

        // Execute SQL query
        window.executeQuery = async function() {
            if (!db) {
                showNotification('Database not initialized. Please wait for WebGPU to load.', 'error');
                return;
            }

            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                showNotification('Please enter a query', 'error');
                return;
            }

            console.log('Executing query:', query);

            try {
                const startTime = performance.now();
                const result = await db.query(query);
                const endTime = performance.now();
                const execTime = endTime - startTime;

                document.getElementById('exec-time').innerHTML = 
                    `${execTime.toFixed(3)}<span class="text-sm ml-1 text-white/40 font-light">ms</span>`;
                
                const cpuEstimate = execTime * 50;
                document.getElementById('speedup').textContent = 
                    `~${(cpuEstimate / execTime).toFixed(0)}x faster than CPU`;

                // Store results for visualization and insights
                lastResults = result;
                
                displayResults(result);
                
                // Auto-enable visualization for query results
                enableVisualizationPanel();
                
                // Show success message with table name if it's a JOIN
                const tableName = result.name || 'query';
                const isJoin = tableName.includes('_join_');
                const message = isJoin 
                    ? `Query executed successfully! ${result.rowCount} rows returned from ${tableName.toUpperCase()} in ${execTime.toFixed(2)}ms ‚ö°`
                    : `Query executed successfully! ${result.rowCount} rows returned in ${execTime.toFixed(2)}ms`;
                
                showNotification(message, 'success');
                
                console.log(`Query executed in ${execTime.toFixed(2)}ms`);
                
            } catch (error) {
                console.error('Query error:', error);
                showNotification(`Query Error: ${error.message}`, 'error');
            }
        };

        // Display query results in table
        function displayResults(result) {
            console.log('üîç displayResults called with:', result);
            
            // Handle GridDB result format: { rows: [...], rowCount: N, columns: [...] }
            let data = result;
            if (result && result.rows) {
                data = result.rows;
                console.log('üìä Extracted rows:', data.length, 'rows');
            }
            
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            const resultCount = document.getElementById('result-count');
            
            // Update table title with actual table name
            const panelTitle = document.querySelector('.panel-title');
            if (panelTitle && result && result.name) {
                const tableName = result.name.toUpperCase();
                const isJoin = tableName.includes('_JOIN_');
                panelTitle.innerHTML = isJoin 
                    ? `<span class="text-[10px] font-bold uppercase tracking-widest text-[#34B27B]">‚ö° ${tableName}</span>`
                    : `<span class="text-[10px] font-bold uppercase tracking-widest text-white/40">${tableName}</span>`;
            }
            
            // Handle empty results - SHOW PROPER MESSAGE
            if (!data || data.length === 0) {
                console.log('‚ö†Ô∏è No data to display');
                console.log('data:', data);
                console.log('result:', result);
                tableHeader.innerHTML = `<th class="p-4 font-bold text-white/40">NO RESULTS</th>`;
                tableBody.innerHTML = `
                    <tr class="table-row">
                        <td class="p-8 text-center">
                            <div class="py-8">
                                <div class="text-4xl mb-3">üì≠</div>
                                <p class="text-white/60 text-base font-semibold mb-2">Query returned 0 rows</p>
                                <p class="text-white/30 text-sm">
                                    Your query executed successfully but found no matching data.<br>
                                    Try adjusting your WHERE conditions or check the table contents.
                                </p>
                                <button onclick="setQuery('SELECT * FROM export LIMIT 10')" 
                                        class="mt-4 px-4 py-2 bg-[#34B27B]/20 hover:bg-[#34B27B]/30 rounded-lg text-sm text-[#34B27B] transition-all">
                                    View All Rows
                                </button>
                            </div>
                        </td>
                    </tr>`;
                resultCount.textContent = '0';
                
                // Show helpful notification
                showNotification('Query executed successfully! 0 rows returned - no matches found.', 'info');
                return;
            }

            // Get column names from first row
            const columns = Object.keys(data[0]);
            
            // Detect column data types
            columnDataTypes.clear();
            columns.forEach(col => {
                const sampleValues = data.slice(0, 100).map(row => row[col]);
                const isNumeric = sampleValues.every(v => !isNaN(parseFloat(v)));
                columnDataTypes.set(col, {
                    type: isNumeric ? 'number' : 'string',
                    isNumeric,
                    unique: new Set(sampleValues).size
                });
            });
            
            // Update header with clickable columns
            tableHeader.innerHTML = columns.map((col, idx) => {
                const dataType = columnDataTypes.get(col);
                const typeBadge = dataType.isNumeric ? 'üî¢' : 'üî§';
                return `<th class="p-4 font-bold column-selectable" 
                    data-column="${col}" 
                    data-index="${idx}"
                    data-type="${dataType.type}"
                    draggable="true"
                    onclick="handleColumnClick(event, '${col}', ${idx})"
                    title="Drag to axis or click to select ${col} (${dataType.type})"
                >${col.toUpperCase()} <span class="column-info-badge">${typeBadge}</span></th>`;
            }).join('');
            
            // Add drag event listeners to column headers
            document.querySelectorAll('.column-selectable').forEach(th => {
                th.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('columnName', th.dataset.column);
                    e.dataTransfer.setData('columnIndex', th.dataset.index);
                    e.dataTransfer.setData('columnType', th.dataset.type);
                    th.classList.add('dragging');
                    
                    // Visual feedback - show which axis slots are available
                    document.querySelectorAll('[id^="viz-"]').forEach(slot => {
                        if (slot.id.includes('axis')) {
                            slot.style.boxShadow = '0 0 15px rgba(52, 178, 123, 0.6)';
                            slot.style.animation = 'pulse 1s infinite';
                        }
                    });
                });
                
                th.addEventListener('dragend', (e) => {
                    th.classList.remove('dragging');
                    
                    // Remove visual feedback
                    document.querySelectorAll('[id^="viz-"]').forEach(slot => {
                        if (slot.id.includes('axis')) {
                            slot.style.boxShadow = '';
                            slot.style.animation = '';
                        }
                    });
                });
            });

            // Update body - show first 1000 rows
            tableBody.innerHTML = data.slice(0, 1000).map(row => `
                <tr class="table-row transition-colors cursor-pointer text-white/70">
                    ${columns.map(col => {
                        let value = row[col];
                        let cellClass = 'p-4';
                        
                        if (col === 'status') {
                            const statusColors = {
                                'active': 'text-[#34B27B] border-[#34B27B]/20 bg-[#34B27B]/5',
                                'inactive': 'text-red-400 border-red-400/20 bg-red-400/5',
                                'pending': 'text-yellow-400 border-yellow-400/20 bg-yellow-400/5',
                                'suspended': 'text-gray-400 border-gray-400/20 bg-gray-400/5'
                            };
                            const colorClass = statusColors[value] || statusColors['inactive'];
                            value = `<span class="${colorClass} border px-2 py-0.5 rounded-full text-[9px] font-bold uppercase">${value}</span>`;
                        } else if (col === 'id' || col.toLowerCase().includes('id')) {
                            cellClass += ' text-white/40 mono';
                            value = `#${value}`;
                        } else if (col === 'name' || col === 'hardware' || col.toLowerCase().includes('name')) {
                            cellClass += ' text-white font-medium';
                        }
                        
                        return `<td class="${cellClass}">${value ?? '<span class="text-white/20 italic">null</span>'}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            resultCount.textContent = data.length.toLocaleString();
            
            console.log(`Displayed ${data.length} rows in results table`);
        }

        // Clear query
        window.clearQuery = function() {
            // Get the first table name if available
            const tables = db ? db.listTables() : [];
            const defaultQuery = tables.length > 0 
                ? `SELECT * FROM ${tables[0]} LIMIT 100`
                : 'SELECT * FROM tablename LIMIT 100';
            
            document.getElementById('queryInput').value = defaultQuery;
        };

        // Toggle JOIN dropdown menu
        window.toggleJoinMenu = function() {
            const menu = document.getElementById('joinMenu');
            menu.classList.toggle('hidden');
        };

        // Close JOIN menu when clicking outside
        document.addEventListener('click', function(event) {
            const joinBtn = document.getElementById('joinBtn');
            const joinMenu = document.getElementById('joinMenu');
            
            if (joinBtn && joinMenu && !joinBtn.contains(event.target) && !joinMenu.contains(event.target)) {
                joinMenu.classList.add('hidden');
            }
        });

        // Insert JOIN template
        window.insertJoin = function(joinType) {
            const tables = db ? db.listTables() : [];
            
            // Close dropdown menu
            document.getElementById('joinMenu').classList.add('hidden');
            
            if (tables.length < 2) {
                showNotification('Load at least 2 tables to use JOIN', 'error');
                return;
            }

            const table1 = tables[0];
            const table2 = tables[1];
            
            const joinQuery = `SELECT * FROM ${table1} ${joinType} JOIN ${table2} ON ${table1}.id = ${table2}.id`;
            
            document.getElementById('queryInput').value = joinQuery;
            showNotification(`${joinType} JOIN template inserted. Edit table and column names as needed. GPU accelerated! ‚ö°`, 'success');
        };

        // Update database stats
        function updateStats() {
            if (!db) return;
            const stats = db.getStats();
            document.getElementById('cache-rate').textContent = 
                stats.cacheHits > 0 ? `${((stats.cacheHits / (stats.cacheHits + stats.cacheMisses)) * 100).toFixed(1)}%` : '0%';
            
            const totalRows = parseInt(document.getElementById('total-rows').textContent.replace(/,/g, '')) || 0;
            const memoryMB = (totalRows * 50 / 1024 / 1024).toFixed(2);
            document.getElementById('gpu-memory').textContent = `${memoryMB} MB`;
        }

        // Progress bar helpers
        function showProgress(text, percent, sizeInfo = '') {
            const progressDiv = document.getElementById('loadProgress');
            const progressBar = document.getElementById('loadProgressBar');
            const progressText = document.getElementById('loadProgressText');
            const progressPercent = document.getElementById('loadProgressPercent');
            const progressSize = document.getElementById('loadProgressSize');
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
            progressPercent.textContent = percent >= 10 ? `${Math.round(percent)}%` : '';
            
            if (sizeInfo) {
                progressSize.textContent = sizeInfo;
            }
        }

        function hideProgress() {
            const progressDiv = document.getElementById('loadProgress');
            progressDiv.classList.add('hidden');
            document.getElementById('loadProgressBar').style.width = '0%';
            document.getElementById('loadProgressPercent').textContent = '';
            document.getElementById('loadProgressSize').textContent = '';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        }

        // Notification helper (shows message in status bar)
        function showNotification(message, type = 'info') {
            // You can enhance this with a toast notification system
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Optional: Show in query info panel
            const queryInfoEl = document.getElementById('queryInfo');
            if (queryInfoEl) {
                const colors = {
                    success: 'text-[#34B27B] bg-[#34B27B]/10 border-[#34B27B]/30',
                    error: 'text-red-400 bg-red-400/10 border-red-400/30',
                    info: 'text-blue-400 bg-blue-400/10 border-blue-400/30'
                };
                const colorClass = colors[type] || colors.info;
                
                queryInfoEl.innerHTML = `
                    <div class="p-3 rounded-lg border ${colorClass} text-xs">
                        ${message}
                    </div>
                `;
            }
        }

        // Update column analysis panel
        function updateColumnAnalysis(tableName) {
            if (!db || !tableName) return;
            
            const table = db.tables.get(tableName);
            if (!table || !table.columns || !table.rows) return;

            const container = document.getElementById('columns-panel');
            
            // Get column statistics
            const columnStats = table.columns.map(col => {
                const uniqueValues = new Set();
                let nullCount = 0;
                
                // Sample values for analysis (first 1000 or all if less)
                const sampleSize = Math.min(1000, table.rowCount);
                for (let i = 0; i < sampleSize; i++) {
                    const val = table.rows[i][col.name];
                    if (val === null || val === undefined || val === '') {
                        nullCount++;
                    } else {
                        uniqueValues.add(val);
                    }
                }

                return {
                    name: col.name,
                    type: col.type,
                    nullCount: nullCount,
                    uniqueCount: uniqueValues.size,
                    totalSize: sampleSize
                };
            });

            // Build HTML
            container.innerHTML = columnStats.map((col, idx) => {
                const typeColor = col.type === 'number' ? 'text-blue-400' : 'text-purple-400';
                const typeIcon = col.type === 'number' ? 'üî¢' : 'üìù';
                const nullPercent = ((col.nullCount / col.totalSize) * 100).toFixed(1);
                const uniquePercent = ((col.uniqueCount / col.totalSize) * 100).toFixed(1);
                
                return `
                    <div class="bg-white/5 rounded-lg p-3 border border-white/5 hover:border-[#34B27B]/30 transition-all">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-base">${typeIcon}</span>
                                <span class="text-white font-semibold text-sm mono">${col.name}</span>
                            </div>
                            <span class="${typeColor} text-xs font-bold uppercase px-2 py-0.5 bg-white/5 rounded">${col.type}</span>
                        </div>
                        <div class="space-y-1 text-xs text-white/50">
                            <div class="flex justify-between">
                                <span>Size:</span>
                                <span class="text-white/70 font-semibold">${table.rowCount.toLocaleString()} rows</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Unique:</span>
                                <span class="text-white/70 font-semibold">${col.uniqueCount.toLocaleString()} (${uniquePercent}%)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Nulls:</span>
                                <span class="text-white/70 font-semibold">${col.nullCount.toLocaleString()} (${nullPercent}%)</span>
                            </div>
                        </div>
                        ${col.type === 'number' ? `
                            <div class="mt-2 pt-2 border-t border-white/5">
                                <div class="text-xs text-[#34B27B]/70 uppercase font-bold">Numeric Column</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Export results to CSV
        window.exportResults = function() {
            if (!lastResults || !lastResults.rows || lastResults.rows.length === 0) {
                alert('No results to export. Run a query first.');
                return;
            }

            try {
                const columns = Object.keys(lastResults.rows[0]);
                const csvRows = [columns.join(',')];
                lastResults.rows.forEach(row => {
                    csvRows.push(columns.map(col => {
                        const val = row[col];
                        // Escape values that contain commas or quotes
                        if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
                            return `"${val.replace(/"/g, '""')}"`;
                        }
                        return val;
                    }).join(','));
                });
                const content = csvRows.join('\n');
                
                const blob = new Blob([content], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `query_results_${Date.now()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log(`Exported ${lastResults.rows.length} rows to CSV`);
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        };

        // File upload handling
        document.getElementById('dropzone').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!db) {
                showNotification('Database not initialized', 'error');
                return;
            }

            const fileSize = formatFileSize(file.size);
            const originalText = document.getElementById('dropzone').innerHTML;
            
            showProgress(`Reading ${file.name}...`, 5, fileSize);

            try {
                // Simulate reading progress for large files
                const readStartTime = performance.now();
                const text = await file.text();
                const readTime = performance.now() - readStartTime;
                
                showProgress('Parsing data structure...', 25, fileSize);
                await new Promise(resolve => setTimeout(resolve, 100)); // Visual feedback
                
                const name = file.name.replace(/\.[^/.]+$/, "");
                
                showProgress('Preparing GPU memory...', 40, fileSize);
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const startTime = performance.now();
                
                if (file.name.endsWith('.csv')) {
                    showProgress('Loading CSV to GPU...', 60, fileSize);
                    await db.loadCSV(name, text);
                } else if (file.name.endsWith('.json')) {
                    showProgress('Loading JSON to GPU...', 60, fileSize);
                    const json = JSON.parse(text);
                    await db.loadJSON(name, json);
                } else {
                    throw new Error('Unsupported file format. Use CSV or JSON.');
                }
                
                showProgress('Building column indexes...', 85, fileSize);
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const loadTime = (performance.now() - startTime).toFixed(0);
                const table = db.tables.get(name);
                
                if (!table) throw new Error('Table was not created properly');
                
                currentTable = name;
                
                showProgress('Analyzing columns...', 95, fileSize);
                
                // Update UI
                document.getElementById('total-rows').textContent = table.rowCount.toLocaleString();
                document.getElementById('dropzone').innerHTML = originalText;
                updateStats();
                updateColumnAnalysis(name);
                
                // Generate suggested queries
                generateSuggestedQueries(name, table);
                
                // Update the SQL query input with the correct table name
                const queryInput = document.getElementById('queryInput');
                if (queryInput) {
                    queryInput.value = `SELECT * FROM ${name} LIMIT 100`;
                }
                
                showProgress('Complete! ‚úì', 100, fileSize);
                
                const totalTime = (performance.now() - readStartTime).toFixed(0);
                console.log(`Loaded table "${name}": ${table.rowCount.toLocaleString()} rows in ${totalTime}ms`);
                
                setTimeout(() => {
                    hideProgress();
                }, 800);
                
                // Auto-display first 1000 rows (but load all for viz)
                setTimeout(async () => {
                    try {
                        const result = await db.query(`SELECT * FROM ${name}`);
                        lastResults = result; // Store for visualizations - ALL ROWS
                        
                        // Display subset in table for performance
                        displayResults({
                            ...result,
                            rows: result.rows.slice(0, 1000)
                        });
                        
                        console.log(`Loaded ${result.rowCount} total rows (showing first 1000 in table)`);
                    } catch (err) {
                        console.log('Auto-query error:', err);
                    }
                }, 900);
                
            } catch (error) {
                console.error('File load error:', error);
                document.getElementById('dropzone').innerHTML = originalText;
                hideProgress();
                showNotification(`Error: ${error.message}`, 'error');
            }
        });

        // Drag and drop
        const dropzone = document.getElementById('dropzone');
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-[#34B27B]/50');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-[#34B27B]/50');
        });
        
        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-[#34B27B]/50');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('fileInput').files = e.dataTransfer.files;
                document.getElementById('fileInput').dispatchEvent(new Event('change'));
            }
        });

        // Visualization functions
        window.showVisualization = function() {
            if (!lastResults || !lastResults.rows || lastResults.rows.length === 0) {
                alert('No results to visualize. Run a query first.');
                return;
            }
            alert('Visualization feature:\n\nThis would show interactive charts with Observable Plot.\nFeature available in griddb_demo.html');
        };

        window.visualizeData = function(type) {
            if (!lastResults || !lastResults.rows || !Plot) {
                return;
            }
            // Chart creation logic would go here
            console.log(`Creating ${type} chart...`);
        };

        // Generate insights
        window.generateInsights = function() {
            if (!lastResults || !lastResults.rows || lastResults.rows.length === 0) {
                alert('No results to analyze. Run a query first.');
                return;
            }

            const columns = Object.keys(lastResults.rows[0]);
            const numericCols = columns.filter(col => typeof lastResults.rows[0][col] === 'number');

            let insights = `QUERY INSIGHTS\n\n`;
            insights += `Total Rows: ${lastResults.rowCount.toLocaleString()}\n`;
            insights += `Columns: ${columns.length}\n\n`;

            // Numeric column stats
            numericCols.forEach(col => {
                const values = lastResults.rows.map(r => r[col]).filter(v => !isNaN(v));
                if (values.length === 0) return;

                const sum = values.reduce((a, b) => a + b, 0);
                const avg = sum / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);

                insights += `${col}:\n`;
                insights += `  ‚Ä¢ Average: ${avg.toFixed(2)}\n`;
                insights += `  ‚Ä¢ Min: ${min.toFixed(2)}\n`;
                insights += `  ‚Ä¢ Max: ${max.toFixed(2)}\n`;
                insights += `  ‚Ä¢ Sum: ${sum.toFixed(2)}\n\n`;
            });

            alert(insights);
            console.log('Insights generated:', insights);
        };

        // Export to JSON
        window.exportJSON = function() {
            if (!lastResults || !lastResults.rows || lastResults.rows.length === 0) {
                alert('No results to export.');
                return;
            }

            const content = JSON.stringify(lastResults.rows, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_results_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log(`Exported ${lastResults.rows.length} rows to JSON`);
        };

        // Set query in editor
        window.setQuery = function(sql) {
            document.getElementById('queryInput').value = sql;
        };

        // Generate suggested queries
        function generateSuggestedQueries(tableName, table) {
            if (!table || !table.columns || table.columns.length === 0) {
                return;
            }

            console.log(`üí° Suggested queries for table "${tableName}":`);
            
            const numericCols = table.columns.filter(c => c.type === 'number');
            const stringCols = table.columns.filter(c => c.type === 'string');

            const suggestions = [];
            
            suggestions.push(`SELECT * FROM ${tableName} LIMIT 10`);
            suggestions.push(`SELECT COUNT(*) FROM ${tableName}`);
            
            if (stringCols.length > 0) {
                const strCol = stringCols[0].name;
                suggestions.push(`SELECT DISTINCT ${strCol} FROM ${tableName}`);
            }
            
            if (numericCols.length > 0) {
                const numCol = numericCols[0].name;
                suggestions.push(`SELECT * FROM ${tableName} ORDER BY ${numCol} DESC LIMIT 10`);
            }
            
            if (stringCols.length > 0 && numericCols.length > 0) {
                const strCol = stringCols[0].name;
                const numCol = numericCols[0].name;
                suggestions.push(`SELECT ${strCol}, AVG(${numCol}), COUNT(*) FROM ${tableName} GROUP BY ${strCol}`);
            }

            console.log('Suggested queries:', suggestions);
            
            // You could add these to a UI element if needed
            return suggestions;
        }

        // Create Table Modal Functions
        let columnCount = 0;

        window.showCreateTableModal = function() {
            const modal = document.getElementById('createTableModal');
            modal.style.display = 'flex';
            
            // Copy table name from input if filled
            const tableName = document.getElementById('newTableName').value;
            if (tableName) {
                document.getElementById('modalTableName').value = tableName;
            }
            
            // Clear and add initial column rows
            document.getElementById('columnsList').innerHTML = '';
            columnCount = 0;
            addColumnRow();
            addColumnRow();
        };

        window.closeCreateTableModal = function() {
            document.getElementById('createTableModal').style.display = 'none';
        };

        window.addColumnRow = function() {
            const columnsList = document.getElementById('columnsList');
            const rowId = `col-${columnCount++}`;
            
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'flex gap-2';
            row.innerHTML = `
                <input 
                    type="text" 
                    placeholder="Column name"
                    class="flex-1 bg-white/5 border border-white/10 rounded px-2 py-1.5 text-xs text-white placeholder-white/30 focus:outline-none focus:border-[#34B27B]/50"
                    data-column-name
                />
                <select 
                    class="bg-white/5 border border-white/10 rounded px-2 py-1.5 text-xs text-white focus:outline-none focus:border-[#34B27B]/50"
                    data-column-type
                >
                    <option value="string">Text</option>
                    <option value="number">Number</option>
                </select>
                <button 
                    onclick="removeColumnRow('${rowId}')"
                    class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-2 py-1.5 rounded text-xs font-bold transition-all"
                >
                    ‚úï
                </button>
            `;
            
            columnsList.appendChild(row);
        };

        window.removeColumnRow = function(rowId) {
            document.getElementById(rowId)?.remove();
        };

        window.createNewTable = async function() {
            if (!db) {
                alert('Database not initialized');
                return;
            }

            const tableName = document.getElementById('modalTableName').value.trim();
            if (!tableName) {
                alert('Please enter a table name');
                return;
            }

            // Validate table name
            if (!/^[a-zA-Z0-9_-]+$/.test(tableName)) {
                alert('Table name can only contain letters, numbers, underscore, and hyphen');
                return;
            }

            if (db.tables.has(tableName)) {
                if (!confirm(`Table "${tableName}" already exists. Overwrite it?`)) {
                    return;
                }
                db.tables.delete(tableName);
            }

            // Get columns
            const columnRows = document.querySelectorAll('#columnsList > div');
            const columns = [];
            
            for (const row of columnRows) {
                const nameInput = row.querySelector('[data-column-name]');
                const typeSelect = row.querySelector('[data-column-type]');
                
                const colName = nameInput.value.trim();
                const colType = typeSelect.value;
                
                if (colName) {
                    columns.push({ name: colName, type: colType });
                }
            }

            if (columns.length === 0) {
                alert('Please add at least one column');
                return;
            }

            // Get initial data
            const initialDataText = document.getElementById('initialData').value.trim();
            let data = [];
            
            if (initialDataText) {
                try {
                    data = JSON.parse(initialDataText);
                    if (!Array.isArray(data)) {
                        throw new Error('Data must be a JSON array');
                    }
                } catch (error) {
                    alert('Invalid JSON data:\n\n' + error.message);
                    return;
                }
            } else {
                // Create empty table with one sample row
                data = [{}];
                columns.forEach(col => {
                    data[0][col.name] = col.type === 'number' ? 0 : '';
                });
            }

            // Create table
            try {
                await db.loadJSON(tableName, data);
                
                currentTable = tableName;
                
                // Update UI
                const table = db.tables.get(tableName);
                document.getElementById('total-rows').textContent = table.rowCount.toLocaleString();
                updateStats();
                updateColumnAnalysis(tableName);
                generateSuggestedQueries(tableName, table);
                
                // Close modal
                closeCreateTableModal();
                
                // Clear inputs
                document.getElementById('newTableName').value = '';
                document.getElementById('modalTableName').value = '';
                document.getElementById('initialData').value = '';
                
                alert(`Table "${tableName}" created successfully!\n\nRows: ${table.rowCount}\nüìã Columns: ${table.columns.length}\n\nReady for queries!`);
                
                // Auto-display the table
                setTimeout(async () => {
                    try {
                        const result = await db.query(`SELECT * FROM ${tableName}`);
                        lastResults = result; // Store ALL rows for visualizations
                        
                        // Display subset in table for performance
                        displayResults({
                            ...result,
                            rows: result.rows.slice(0, 1000)
                        });
                    } catch (err) {
                        console.log('Auto-query error:', err);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Table creation error:', error);
                alert('Error creating table:\n\n' + error.message);
            }
        };

        // ============================================
        // COLUMN SELECTION & VISUALIZATION SYSTEM
        // ============================================

        /**
         * Enable visualization panel after query execution
         * Auto-selects first 2-3 numeric columns for immediate visualization
         */
        function enableVisualizationPanel() {
            if (!lastResults || !lastResults.rows || lastResults.rows.length === 0) {
                return;
            }

            const data = lastResults.rows;
            const columns = Object.keys(data[0]);
            
            // Auto-select first 2-3 numeric columns for quick visualization
            selectedColumns = [];
            let numericCount = 0;
            
            for (let i = 0; i < columns.length && numericCount < 3; i++) {
                const col = columns[i];
                const dataType = columnDataTypes.get(col);
                
                if (dataType?.isNumeric) {
                    selectedColumns.push({ name: col, index: numericCount });
                    numericCount++;
                }
            }
            
            // If not enough numeric columns, add any columns
            if (selectedColumns.length < 2) {
                selectedColumns = [];
                for (let i = 0; i < Math.min(columns.length, 2); i++) {
                    selectedColumns.push({ name: columns[i], index: i });
                }
            }

            console.log('Auto-selected columns for visualization:', selectedColumns.map(c => c.name));

            // Update UI
            updateColumnSelectionUI();
            updateVisualizationPanel();

            // Enable visualize button
            const vizBtn = document.getElementById('viz-visualize-btn');
            if (vizBtn) {
                vizBtn.disabled = false;
                vizBtn.className = 'w-full bg-gradient-to-r from-[#34B27B] to-[#2d9a68] hover:from-[#2d9a68] hover:to-[#34B27B] text-black text-sm font-bold uppercase py-2.5 rounded-lg transition-all glow-border shadow-lg';
                vizBtn.style.cursor = 'pointer';
            }

            // Show notification with helpful tip
            showNotification(`‚ú® ${selectedColumns.length} columns auto-selected for visualization! Click VISUALIZE button or click column headers to customize.`, 'success');
        }

        /**
         * Handle column header click
         */
        window.handleColumnClick = async function(event, columnName, columnIndex) {
            event.stopPropagation();
            
            // Always load full dataset from current table for visualization
            if (currentTable) {
                showNotification('Loading ALL data from table for visualization...', 'info');
                try {
                    const result = await db.query(`SELECT * FROM ${currentTable}`);
                    lastResults = result;
                    console.log(`Loaded ALL ${result.rowCount} rows for visualization`);
                    showNotification(`Loaded ${result.rowCount.toLocaleString()} rows`, 'success');
                } catch (err) {
                    showNotification('Failed to load data: ' + err.message, 'error');
                    return;
                }
            } else if (!lastResults) {
                showNotification('No table loaded. Please load data first.', 'error');
                return;
            }
            
            // Multi-select with Ctrl/Cmd
            if (event.ctrlKey || event.metaKey) {
                isMultiSelectMode = true;
                toggleColumnSelection(columnName, columnIndex);
            } else {
                // Single select
                isMultiSelectMode = false;
                selectedColumns = [{ name: columnName, index: columnIndex }];
                updateColumnSelectionUI();
            }

            // Update visualization panel (no popup menu)
            if (selectedColumns.length > 0) {
                updateVisualizationPanel();
                
                // Scroll to visualization panel
                const vizPanel = document.getElementById('visualization-panel');
                if (vizPanel && !vizPanel.closest('section').classList.contains('panel-collapsed')) {
                    vizPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        };

        /**
         * Open axis editor to rearrange columns
         */
        window.openAxisEditor = function() {
            const menu = document.getElementById('viz-menu');
            if (menu) menu.remove();
            
            // Get all available columns from last results
            const data = lastResults.rows || lastResults;
            const allColumns = Object.keys(data[0]);
            
            // Create axis editor modal
            const editor = document.createElement('div');
            editor.className = 'viz-modal';
            editor.innerHTML = `
                <div class="viz-modal-content" style="width: 600px; height: auto; max-height: 80vh;">
                    <div class="p-6 border-b border-white/10 flex justify-between items-center">
                        <h2 class="text-2xl font-bold outfit text-[#34B27B] glow-text">Configure Axes</h2>
                        <button onclick="this.closest('.viz-modal').remove()" class="text-white/50 hover:text-white text-2xl">‚úï</button>
                    </div>
                    <div class="p-6 space-y-4 overflow-y-auto" style="max-height: 60vh;">
                        <div class="text-sm text-white/50 mb-4">
                            Select columns for each axis. Choose X and Y for 2D plots, add Z for 3D!
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <label class="w-20 text-lg font-bold" style="color: #FF6B6B">X Axis:</label>
                                <select id="axis-x" class="flex-1 bg-[#11181C] border border-white/20 rounded-lg px-4 py-2 text-white">
                                    <option value="">-- Select Column --</option>
                                    ${allColumns.map(col => `<option value="${col}" ${selectedColumns[0]?.name === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <label class="w-20 text-lg font-bold" style="color: #4ECDC4">Y Axis:</label>
                                <select id="axis-y" class="flex-1 bg-[#11181C] border border-white/20 rounded-lg px-4 py-2 text-white">
                                    <option value="">-- Select Column --</option>
                                    ${allColumns.map(col => `<option value="${col}" ${selectedColumns[1]?.name === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <label class="w-20 text-lg font-bold" style="color: #45B7D1">Z Axis:</label>
                                <select id="axis-z" class="flex-1 bg-[#11181C] border border-white/20 rounded-lg px-4 py-2 text-white">
                                    <option value="">-- None (2D) --</option>
                                    ${allColumns.map(col => `<option value="${col}" ${selectedColumns[2]?.name === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <label class="w-20 text-lg font-bold" style="color: #FFA07A">Color:</label>
                                <select id="axis-color" class="flex-1 bg-[#11181C] border border-white/20 rounded-lg px-4 py-2 text-white">
                                    <option value="">-- None --</option>
                                    ${allColumns.map(col => `<option value="${col}" ${selectedColumns[3]?.name === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-white/10 flex gap-3 justify-end">
                        <button onclick="this.closest('.viz-modal').remove()" 
                                class="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all">
                            Cancel
                        </button>
                        <button onclick="applyAxisConfiguration()" 
                                class="px-6 py-2 bg-[#34B27B] hover:bg-[#2a9463] rounded-lg font-bold transition-all">
                            Apply & Visualize
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editor);
        };

        /**
         * Apply axis configuration and show viz menu
         */
        window.applyAxisConfiguration = function() {
            const xCol = document.getElementById('axis-x').value;
            const yCol = document.getElementById('axis-y').value;
            const zCol = document.getElementById('axis-z').value;
            const colorCol = document.getElementById('axis-color').value;
            
            if (!xCol) {
                showNotification('Please select at least X axis', 'error');
                return;
            }
            
            // Update selected columns
            selectedColumns = [];
            if (xCol) selectedColumns.push({ name: xCol, index: 0 });
            if (yCol) selectedColumns.push({ name: yCol, index: 1 });
            if (zCol) selectedColumns.push({ name: zCol, index: 2 });
            if (colorCol) selectedColumns.push({ name: colorCol, index: 3 });
            
            // Close editor
            document.querySelector('.viz-modal').remove();
            
            // Update column selection UI
            updateColumnSelectionUI();
            
            // Show viz menu at center of screen
            const event = {
                pageX: window.innerWidth / 2,
                pageY: window.innerHeight / 3
            };
            showVisualizationMenu(event, selectedColumns);
        };

        /**
         * Open column picker to add more columns
         */
        window.openColumnPicker = function() {
            openAxisEditor();
        };

        /**
         * Toggle column selection
         */
        function toggleColumnSelection(columnName, columnIndex) {
            const existingIndex = selectedColumns.findIndex(c => c.name === columnName);
            
            if (existingIndex >= 0) {
                selectedColumns.splice(existingIndex, 1);
            } else {
                selectedColumns.push({ name: columnName, index: columnIndex });
            }
            
            updateColumnSelectionUI();
        }

        /**
         * Update visual state of selected columns
         */
        function updateColumnSelectionUI() {
            // Clear all selections
            document.querySelectorAll('.column-selectable').forEach(th => {
                th.classList.remove('column-selected');
            });
            
            // Highlight selected
            selectedColumns.forEach(col => {
                const th = document.querySelector(`.column-selectable[data-column="${col.name}"]`);
                if (th) {
                    th.classList.add('column-selected');
                }
            });

            // Update visualization panel
            updateVisualizationPanel();
        }

        /**
         * Update the persistent visualization panel in sidebar
         */
        function updateVisualizationPanel() {
            const vizPanel = document.getElementById('viz-selected-columns');
            const vizBtn = document.getElementById('viz-visualize-btn');
            
            if (!vizPanel || !vizBtn) return;

            // Check if any axes have columns assigned
            const xAxis = document.getElementById('viz-x-axis')?.dataset.column;
            const yAxis = document.getElementById('viz-y-axis')?.dataset.column;
            const zAxis = document.getElementById('viz-z-axis')?.dataset.column;
            const hasAxesAssigned = !!(xAxis || yAxis || zAxis);

            // Update selected columns display
            if (selectedColumns.length === 0) {
                vizPanel.innerHTML = '<p class="text-[10px] text-white/20 text-center py-2">Click or drag columns from table above</p>';
            } else {
                vizPanel.innerHTML = selectedColumns.map((col, idx) => {
                    const dataType = columnDataTypes.get(col.name);
                    const icon = dataType?.isNumeric ? 'üî¢' : 'üî§';
                    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
                    return `
                        <div class="viz-column-chip" data-column="${col.name}" draggable="true" style="border-left: 3px solid ${colors[idx % colors.length]}">
                            <span class="flex-1">${icon} ${col.name}</span>
                            <button onclick="removeColumnFromSelection('${col.name}')" class="text-white/40 hover:text-red-400 ml-2">‚úï</button>
                        </div>
                    `;
                }).join('');

                // Add drag event listeners
                initColumnDragging();
            }

            // Enable visualize button if columns are selected OR axes are assigned
            if (selectedColumns.length > 0 || hasAxesAssigned) {
                vizBtn.disabled = false;
                vizBtn.className = 'w-full bg-gradient-to-r from-[#34B27B] to-[#2d9a68] hover:from-[#2d9a68] hover:to-[#34B27B] text-black text-[10px] font-bold uppercase py-2.5 rounded-lg transition-all glow-border shadow-lg';
                vizBtn.style.cursor = 'pointer';
            } else {
                vizBtn.disabled = true;
                vizBtn.className = 'w-full bg-[#34B27B]/20 text-white/30 text-[10px] font-bold uppercase py-2.5 rounded-lg transition-all cursor-not-allowed';
            }

            // Update axis slots to show which columns are assigned
            updateAxisSlots();
        }

        /**
         * Initialize drag-and-drop for column chips
         */
        function initColumnDragging() {
            const chips = document.querySelectorAll('.viz-column-chip');
            chips.forEach(chip => {
                chip.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('columnName', chip.dataset.column);
                    chip.style.opacity = '0.5';
                });

                chip.addEventListener('dragend', (e) => {
                    chip.style.opacity = '1';
                });

                // Also make chips clickable to assign to next available axis
                chip.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') return; // Skip if clicking remove button
                    assignColumnToNextAxis(chip.dataset.column);
                });
            });
        }

        /**
         * Remove column from selection
         */
        window.removeColumnFromSelection = function(columnName) {
            selectedColumns = selectedColumns.filter(c => c.name !== columnName);
            updateColumnSelectionUI();
            
            // Also clear from axis assignments
            const axisIds = ['viz-x-axis', 'viz-y-axis', 'viz-z-axis', 'viz-color-axis'];
            axisIds.forEach(id => {
                const slot = document.getElementById(id);
                if (slot?.dataset.column === columnName) {
                    clearAxisSlot(id);
                }
            });
        };

        /**
         * Assign column to the next available axis
         */
        function assignColumnToNextAxis(columnName) {
            const axisIds = ['viz-x-axis', 'viz-y-axis', 'viz-z-axis', 'viz-color-axis'];
            
            for (const axisId of axisIds) {
                const slot = document.getElementById(axisId);
                if (!slot.dataset.column) {
                    assignColumnToAxis(columnName, axisId);
                    return;
                }
            }
            
            // If all slots full, show message
            showNotification('All axis slots are assigned. Clear one first!', 'info');
        }

        /**
         * Assign a column to a specific axis slot
         */
        function assignColumnToAxis(columnName, axisId) {
            const slot = document.getElementById(axisId);
            
            // Prevent duplicate assignments during drag
            if (slot.dataset.column === columnName) {
                console.log(`‚è≠Column "${columnName}" already assigned to ${axisId}`);
                return;
            }
            
            // Get or create column data type if dragging from header
            let dataType = columnDataTypes.get(columnName);
            if (!dataType) {
                // If column isn't in selectedColumns, add it
                console.log(`[INFO] Adding ${columnName} to selected columns from drag`);
                const columnIndex = Array.from(document.querySelectorAll('.column-selectable'))
                    .findIndex(th => th.dataset.column === columnName);
                if (columnIndex >= 0 && !selectedColumns.find(c => c.name === columnName)) {
                    selectedColumns.push({ name: columnName, index: columnIndex });
                    updateColumnSelectionUI();
                }
            }
            
            dataType = columnDataTypes.get(columnName);
            if (!dataType) {
                showNotification('Column data type not available', 'error');
                return;
            }

            const icon = dataType?.isNumeric ? 'üî¢' : 'üî§';
            const typeLabel = dataType?.isNumeric ? 'numeric' : 'text';
            const typeColor = dataType?.isNumeric ? '#34B27B' : '#FFA07A';
            
            slot.dataset.column = columnName;
            slot.innerHTML = `
                <span class="flex-1 text-white/90 flex items-center gap-1">
                    ${icon} ${columnName}
                    <span class="text-[8px] px-1.5 py-0.5 rounded" style="background: ${typeColor}20; color: ${typeColor}">${typeLabel}</span>
                </span>
                <button onclick="clearAxisSlot('${axisId}')" class="text-white/40 hover:text-red-400">‚úï</button>
            `;
            slot.style.borderColor = 'rgba(52, 178, 123, 0.5)';

            console.log(`[SUCCESS] Assigned "${columnName}" to ${axisId.replace('viz-', '').replace('-', ' ').toUpperCase()}`);

            // Debounce the UI updates to prevent multiple rapid calls
            clearTimeout(axisAssignmentDebounce);
            axisAssignmentDebounce = setTimeout(() => {
                // Filter graph types based on assignments
                updateGraphTypeFilters();
                
                // Auto-select appropriate graph type when axes are assigned
                autoSelectGraphType();
                
                // Force update visualization panel to enable button
                updateVisualizationPanel();
            }, 100); // Wait 100ms after last drop before updating
        }

        /**
         * Clear an axis slot
         */
        window.clearAxisSlot = function(axisId) {
            const slot = document.getElementById(axisId);
            delete slot.dataset.column;
            
            const placeholders = {
                'viz-x-axis': 'Click column or drag here',
                'viz-y-axis': 'Click column or drag here',
                'viz-z-axis': 'Optional (3D only)',
                'viz-color-axis': 'Optional'
            };
            
            slot.innerHTML = `<span class="text-white/20">${placeholders[axisId] || 'Drop here'}</span>`;
            slot.style.borderColor = 'rgba(255, 255, 255, 0.1)';

            // Update graph type filters
            updateGraphTypeFilters();
        };

        /**
         * Update axis slot displays
         */
        function updateAxisSlots() {
            // Prevent re-initialization of event listeners
            if (axisSlotsInitialized) return;
            
            // Initialize drop zones
            const axisIds = ['viz-x-axis', 'viz-y-axis', 'viz-z-axis', 'viz-color-axis'];
            
            axisIds.forEach((axisId, idx) => {
                const slot = document.getElementById(axisId);
                if (!slot) return;

                // Add drop event listeners
                slot.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    slot.classList.add('drag-over');
                });

                slot.addEventListener('dragleave', (e) => {
                    slot.classList.remove('drag-over');
                });

                slot.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Prevent bubbling
                    slot.classList.remove('drag-over');
                    
                    const columnName = e.dataTransfer.getData('columnName');
                    if (columnName && !slot.dataset.column) { // Only if slot is empty or different
                        assignColumnToAxis(columnName, axisId);
                    }
                }, { once: false }); // Keep listener but check for duplicates in assignColumnToAxis

                // Make slots clickable to select from available columns
                slot.addEventListener('click', (e) => {
                    // Don't trigger if clicking the clear button
                    if (e.target.tagName === 'BUTTON') return;
                    
                    if (selectedColumns.length === 0) {
                        showNotification('üí° Drag columns from the table header above, or click columns to select them first', 'info');
                        return;
                    }
                    showAxisColumnPicker(axisId);
                });
            });
            
            axisSlotsInitialized = true;
            console.log('Axis slots initialized with drop zones');
        }

        /**
         * Show a picker to select which column to assign to an axis
         */
        function showAxisColumnPicker(axisId) {
            const slot = document.getElementById(axisId);
            const rect = slot.getBoundingClientRect();

            // Remove existing picker
            const existing = document.querySelector('.axis-column-picker');
            if (existing) existing.remove();

            const picker = document.createElement('div');
            picker.className = 'axis-column-picker';
            picker.style.cssText = `
                position: fixed;
                left: ${rect.right + 10}px;
                top: ${rect.top}px;
                background: #1a2332;
                border: 1px solid rgba(52, 178, 123, 0.3);
                border-radius: 8px;
                padding: 8px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                max-height: 300px;
                overflow-y: auto;
            `;

            picker.innerHTML = `
                <div class="text-[10px] text-white/40 uppercase mb-2 px-2">Select Column</div>
                ${selectedColumns.map(col => {
                    const dataType = columnDataTypes.get(col.name);
                    const icon = dataType?.isNumeric ? 'üî¢' : 'üî§';
                    return `
                        <div class="axis-picker-option" data-column="${col.name}">
                            ${icon} ${col.name}
                        </div>
                    `;
                }).join('')}
            `;

            document.body.appendChild(picker);

            // Add click handlers
            picker.querySelectorAll('.axis-picker-option').forEach(option => {
                option.addEventListener('click', () => {
                    assignColumnToAxis(option.dataset.column, axisId);
                    picker.remove();
                });
            });

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closePicker(e) {
                    if (!picker.contains(e.target) && e.target !== slot) {
                        picker.remove();
                        document.removeEventListener('click', closePicker);
                    }
                });
            }, 100);
        }

        /**
         * Initialize graph type selector
         */
        function initGraphTypeSelector() {
            const graphOptions = document.querySelectorAll('.viz-graph-option');
            let selectedGraphType = null;

            graphOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove previous selection
                    graphOptions.forEach(opt => {
                        opt.classList.remove('viz-graph-selected');
                        opt.querySelector('.viz-selected-indicator').classList.add('hidden');
                    });

                    // Select this one
                    option.classList.add('viz-graph-selected');
                    option.querySelector('.viz-selected-indicator').classList.remove('hidden');
                    selectedGraphType = option.dataset.graphType;

                    // Store for visualization
                    window.selectedGraphType = selectedGraphType;
                });
            });
        }

        /**
         * Auto-select appropriate graph type based on assigned axes
         */
        function autoSelectGraphType() {
            const xAxis = document.getElementById('viz-x-axis').dataset.column;
            const yAxis = document.getElementById('viz-y-axis').dataset.column;
            const zAxis = document.getElementById('viz-z-axis').dataset.column;

            // Get data types
            const xType = xAxis ? columnDataTypes.get(xAxis) : null;
            const yType = yAxis ? columnDataTypes.get(yAxis) : null;
            const zType = zAxis ? columnDataTypes.get(zAxis) : null;

            const xIsNumeric = xType?.isNumeric || false;
            const yIsNumeric = yType?.isNumeric || false;
            const zIsNumeric = zType?.isNumeric || false;

            let suggestedType = null;

            // Determine best graph type
            if (xAxis && yAxis && zAxis && xIsNumeric && yIsNumeric && zIsNumeric) {
                suggestedType = '3d-scatter';
            } else if (xAxis && yAxis && xIsNumeric && yIsNumeric) {
                suggestedType = '2d-scatter';
            } else if ((xAxis && xIsNumeric) || (yAxis && yIsNumeric)) {
                suggestedType = 'histogram';
            } else if ((xAxis && !xIsNumeric) || (yAxis && !yIsNumeric)) {
                suggestedType = 'bar';
            }

            // Auto-select the graph type
            if (suggestedType) {
                const graphOptions = document.querySelectorAll('.viz-graph-option');
                graphOptions.forEach(opt => {
                    opt.classList.remove('viz-graph-selected');
                    opt.querySelector('.viz-selected-indicator').classList.add('hidden');
                    
                    if (opt.dataset.graphType === suggestedType) {
                        opt.classList.add('viz-graph-selected');
                        opt.querySelector('.viz-selected-indicator').classList.remove('hidden');
                        window.selectedGraphType = suggestedType;
                        
                        // Scroll to show selected type
                        opt.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
                
                console.log(`Auto-selected graph type: ${suggestedType}`);
            }
        }

        /**
         * Update graph type filters based on axis assignments
         */
        function updateGraphTypeFilters() {
            const xAxis = document.getElementById('viz-x-axis').dataset.column;
            const yAxis = document.getElementById('viz-y-axis').dataset.column;
            const zAxis = document.getElementById('viz-z-axis').dataset.column;

            // Get data types
            const xType = xAxis ? columnDataTypes.get(xAxis) : null;
            const yType = yAxis ? columnDataTypes.get(yAxis) : null;
            const zType = zAxis ? columnDataTypes.get(zAxis) : null;

            const xIsNumeric = xType?.isNumeric || false;
            const yIsNumeric = yType?.isNumeric || false;
            const zIsNumeric = zType?.isNumeric || false;

            const graphOptions = document.querySelectorAll('.viz-graph-option');

            graphOptions.forEach(option => {
                const graphType = option.dataset.graphType;
                let isAvailable = false;
                let reason = '';

                switch (graphType) {
                    case '3d-scatter':
                        isAvailable = xAxis && yAxis && zAxis && xIsNumeric && yIsNumeric && zIsNumeric;
                        if (xAxis && yAxis && zAxis && (!xIsNumeric || !yIsNumeric || !zIsNumeric)) {
                            reason = 'Requires 3 numeric columns';
                        }
                        break;
                    
                    case '2d-scatter':
                        isAvailable = xAxis && yAxis && xIsNumeric && yIsNumeric;
                        if (xAxis && yAxis && (!xIsNumeric || !yIsNumeric)) {
                            reason = 'Requires 2 numeric columns';
                        }
                        break;
                    
                    case 'line':
                        isAvailable = xAxis && yAxis && xIsNumeric && yIsNumeric;
                        if (xAxis && yAxis && (!xIsNumeric || !yIsNumeric)) {
                            reason = 'Requires 2 numeric columns';
                        }
                        break;
                    
                    case 'bar':
                        // Bar chart works with: string X + numeric Y, or just one string column
                        isAvailable = (xAxis && !xIsNumeric) || (yAxis && !yIsNumeric) || (xAxis && yAxis);
                        break;
                    
                    case 'pie':
                        // Pie chart works with string column (categories)
                        isAvailable = (xAxis && !xIsNumeric) || (yAxis && !yIsNumeric);
                        if (xAxis && xIsNumeric && yAxis && yIsNumeric) {
                            reason = 'Requires at least 1 text column for categories';
                        }
                        break;
                    
                    case 'histogram':
                        // Histogram requires numeric column
                        isAvailable = (xAxis && xIsNumeric) || (yAxis && yIsNumeric);
                        if ((xAxis && !xIsNumeric) && (yAxis && !yIsNumeric)) {
                            reason = 'Requires numeric column';
                        }
                        break;
                    
                    case 'kpi':
                        // KPI requires numeric column
                        isAvailable = (xAxis && xIsNumeric) || (yAxis && yIsNumeric);
                        if ((xAxis && !xIsNumeric) && (yAxis && !yIsNumeric)) {
                            reason = 'Requires numeric column';
                        }
                        break;
                    
                    default:
                        isAvailable = true;
                }

                const descDiv = option.querySelector('.text-\\[9px\\]');
                
                if (isAvailable) {
                    option.classList.remove('viz-graph-disabled');
                    option.style.opacity = '1';
                    option.style.pointerEvents = 'auto';
                    option.style.borderColor = '';
                    if (descDiv && reason) {
                        descDiv.textContent = descDiv.dataset.originalText || descDiv.textContent;
                    }
                } else {
                    option.classList.add('viz-graph-disabled');
                    option.style.opacity = '0.3';
                    option.style.pointerEvents = 'none';
                    option.style.borderColor = 'rgba(255, 0, 0, 0.2)';
                    
                    if (descDiv && reason) {
                        if (!descDiv.dataset.originalText) {
                            descDiv.dataset.originalText = descDiv.textContent;
                        }
                        descDiv.textContent = reason;
                        descDiv.style.color = 'rgba(255, 100, 100, 0.8)';
                    }
                }
            });

            // Show helpful message
            showGraphTypeRecommendation(xAxis, yAxis, zAxis, xIsNumeric, yIsNumeric, zIsNumeric);
        }

        /**
         * Show recommendation based on selected columns
         */
        function showGraphTypeRecommendation(xAxis, yAxis, zAxis, xIsNumeric, yIsNumeric, zIsNumeric) {
            const vizPanel = document.getElementById('visualization-panel');
            let existingMsg = document.getElementById('viz-recommendation');
            
            if (existingMsg) existingMsg.remove();

            if (!xAxis && !yAxis) return;

            const msg = document.createElement('div');
            msg.id = 'viz-recommendation';
            msg.className = 'mt-2 p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg text-[10px]';
            
            let recommendation = '';
            
            if (xAxis && yAxis && zAxis && xIsNumeric && yIsNumeric && zIsNumeric) {
                recommendation = '‚ú® Perfect for 3D Scatter Plot!';
                msg.style.borderColor = 'rgba(52, 178, 123, 0.5)';
                msg.style.background = 'rgba(52, 178, 123, 0.1)';
            } else if (xAxis && yAxis && xIsNumeric && yIsNumeric) {
                recommendation = '‚ú® Perfect for 2D Scatter or Line Chart!';
                msg.style.borderColor = 'rgba(52, 178, 123, 0.5)';
                msg.style.background = 'rgba(52, 178, 123, 0.1)';
            } else if ((xAxis && xIsNumeric) || (yAxis && yIsNumeric)) {
                recommendation = 'üí° Try Histogram or KPI Card for numeric data';
                msg.style.borderColor = 'rgba(100, 150, 255, 0.5)';
                msg.style.background = 'rgba(100, 150, 255, 0.1)';
            } else if ((xAxis && !xIsNumeric) || (yAxis && !yIsNumeric)) {
                recommendation = 'üí° Try Bar Chart or Pie Chart for text data';
                msg.style.borderColor = 'rgba(255, 200, 100, 0.5)';
                msg.style.background = 'rgba(255, 200, 100, 0.1)';
            }
            
            if (recommendation) {
                msg.innerHTML = `<span class="text-white/80">${recommendation}</span>`;
                const graphTypeSection = document.getElementById('viz-graph-types').parentElement;
                graphTypeSection.insertBefore(msg, graphTypeSection.querySelector('#viz-graph-types'));
            }
        }

        /**
         * Trigger visualization from the panel button
         */
        window.triggerVisualization = function() {
            console.log('Visualize button clicked!');
            
            const graphType = window.selectedGraphType;
            console.log('Selected graph type:', graphType);
            
            if (!graphType) {
                showNotification('Please select a graph type from the list', 'error');
                return;
            }

            const xAxis = document.getElementById('viz-x-axis').dataset.column;
            const yAxis = document.getElementById('viz-y-axis').dataset.column;
            const zAxis = document.getElementById('viz-z-axis').dataset.column;
            const colorAxis = document.getElementById('viz-color-axis').dataset.column;
            
            console.log('Axes:', { xAxis, yAxis, zAxis, colorAxis });

            // Get data types
            const xType = xAxis ? columnDataTypes.get(xAxis) : null;
            const yType = yAxis ? columnDataTypes.get(yAxis) : null;
            const zType = zAxis ? columnDataTypes.get(zAxis) : null;

            const xIsNumeric = xType?.isNumeric || false;
            const yIsNumeric = yType?.isNumeric || false;
            const zIsNumeric = zType?.isNumeric || false;

            // Validate based on graph type
            let validationError = null;

            switch (graphType) {
                case '3d-scatter':
                    if (!xAxis || !yAxis || !zAxis) {
                        validationError = '3D Scatter requires X, Y, and Z axes to be assigned';
                    } else if (!xIsNumeric || !yIsNumeric || !zIsNumeric) {
                        validationError = `3D Scatter requires all numeric columns!\n${xAxis} is ${xIsNumeric ? '‚úì' : '‚úó'} numeric\n${yAxis} is ${yIsNumeric ? '‚úì' : '‚úó'} numeric\n${zAxis} is ${zIsNumeric ? '‚úì' : '‚úó'} numeric`;
                    }
                    break;

                case '2d-scatter':
                case 'line':
                    if (!xAxis || !yAxis) {
                        validationError = `${graphType === '2d-scatter' ? '2D Scatter' : 'Line Chart'} requires X and Y axes to be assigned`;
                    } else if (!xIsNumeric || !yIsNumeric) {
                        validationError = `${graphType === '2d-scatter' ? '2D Scatter' : 'Line Chart'} requires numeric columns!\n${xAxis} is ${xIsNumeric ? 'numeric ‚úì' : 'TEXT ‚úó'}\n${yAxis} is ${yIsNumeric ? 'numeric ‚úì' : 'TEXT ‚úó'}`;
                    }
                    break;

                case 'histogram':
                case 'kpi':
                    if (!xAxis && !yAxis) {
                        validationError = `${graphType === 'histogram' ? 'Histogram' : 'KPI Card'} requires at least one axis`;
                    } else if (!xIsNumeric && !yIsNumeric) {
                        validationError = `${graphType === 'histogram' ? 'Histogram' : 'KPI Card'} requires a NUMERIC column! You selected text columns.`;
                    }
                    break;

                case 'bar':
                case 'pie':
                    if (!xAxis && !yAxis) {
                        validationError = `${graphType === 'bar' ? 'Bar Chart' : 'Pie Chart'} requires at least one axis`;
                    }
                    break;
            }

            if (validationError) {
                showNotification('' + validationError, 'error');
                return;
            }

            // Build columns array based on axis assignments
            const columns = [];
            if (xAxis) columns.push({ name: xAxis, index: 0 });
            if (yAxis) columns.push({ name: yAxis, index: 1 });
            if (zAxis) columns.push({ name: zAxis, index: 2 });
            if (colorAxis) columns.push({ name: colorAxis, index: 3 });

            if (columns.length === 0) {
                showNotification('Please assign columns to axes', 'error');
                return;
            }

            // Call visualization
            createVisualization(graphType, columns);
        };

        /**
         * Update visual state of selected columns
         */
        /**
         * Show visualization menu popup (deprecated - using panel now)
         */
        function showVisualizationMenu(event, columns) {
            // Remove existing menu
            const existingMenu = document.getElementById('viz-menu');
            if (existingMenu) existingMenu.remove();

            const menu = document.createElement('div');
            menu.id = 'viz-menu';
            menu.className = 'viz-menu';
            
            // Position near click
            menu.style.left = `${event.pageX}px`;
            menu.style.top = `${event.pageY + 10}px`;

            // Get recommended visualizations
            const recommendations = getVisualizationRecommendations(columns);
            
            const columnNames = columns.map(c => c.name);
            
            // Show axis assignment editor for multi-column selection
            const axisAssignment = columns.length >= 2 ? `
                <div class="p-3 bg-black/30 rounded-lg mb-2 text-xs">
                    <div class="text-white/50 mb-2 font-bold uppercase tracking-wider flex items-center justify-between">
                        <span>Axis Assignment</span>
                        <button onclick="openAxisEditor()" class="text-[#34B27B] hover:text-[#4ECDC4] text-xs">‚úé Edit</button>
                    </div>
                    ${columns.map((col, idx) => {
                        const axis = ['X', 'Y', 'Z', 'Color'][idx] || `C${idx - 3}`;
                        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
                        return `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-mono font-bold" style="color: ${colors[idx]}">${axis}:</span>
                            <span class="text-[#34B27B]">${col.name}</span>
                        </div>
                        `;
                    }).join('')}
                </div>
            ` : '';

            menu.innerHTML = `
                <div class="viz-menu-header">
                    Visualize ${columns.length} column${columns.length > 1 ? 's' : ''}
                    ${columns.length === 1 ? `<button onclick="event.stopPropagation(); openColumnPicker()" class="ml-2 text-xs text-[#34B27B] hover:text-[#4ECDC4]">+ Add Column</button>` : ''}
                </div>
                ${axisAssignment}
                ${recommendations.map((rec, idx) => `
                    <div class="viz-option ${rec.recommended ? 'viz-option-recommended' : ''}" 
                         data-viz-type="${rec.type}"
                         data-option-index="${idx}">
                        <span class="viz-option-icon">${rec.icon}</span>
                        <span class="viz-option-label">${rec.label}</span>
                        ${rec.recommended ? '<span class="viz-option-badge">BEST</span>' : ''}
                        ${rec.webgpu ? '<span class="viz-option-badge">GPU</span>' : ''}
                    </div>
                `).join('')}
                <div class="viz-option" data-viz-type="cancel">
                    <span class="viz-option-icon">‚úï</span>
                    <span class="viz-option-label">Cancel</span>
                </div>
            `;

            document.body.appendChild(menu);
            
            // Add click handlers
            menu.querySelectorAll('.viz-option').forEach(option => {
                option.addEventListener('click', () => {
                    const vizType = option.getAttribute('data-viz-type');
                    if (vizType === 'cancel') {
                        menu.remove();
                    } else {
                        createVisualization(vizType, columnNames);
                    }
                });
            });

            // Close menu on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                }, { once: true });
            }, 100);
        }

        /**
         * Get smart visualization recommendations based on data types
         */
        function getVisualizationRecommendations(columns) {
            const recommendations = [];
            const types = columns.map(c => columnDataTypes.get(c.name));
            const numCount = types.filter(t => t.isNumeric).length;
            const strCount = types.filter(t => !t.isNumeric).length;

            // Single column
            if (columns.length === 1) {
                const type = types[0];
                if (type.isNumeric) {
                    recommendations.push(
                        { type: 'histogram', icon: '', label: 'Histogram', recommended: true, webgpu: true },
                        { type: 'kpi', icon: 'üìà', label: 'KPI Card', recommended: false, webgpu: true },
                        { type: 'boxplot', icon: 'üì¶', label: 'Box Plot', recommended: false }
                    );
                } else {
                    recommendations.push(
                        { type: 'bar', icon: '', label: 'Bar Chart', recommended: true },
                        { type: 'pie', icon: 'ü•ß', label: 'Pie Chart', recommended: true },
                        { type: 'wordcloud', icon: '‚òÅ', label: 'Word Cloud', recommended: false }
                    );
                }
            }
            
            // Two columns
            else if (columns.length === 2) {
                if (numCount === 2) {
                    // Both numeric
                    recommendations.push(
                        { type: 'scatter', icon: '‚ö´', label: '2D Scatter Plot', recommended: true, webgpu: true },
                        { type: 'line', icon: 'üìà', label: 'Line Chart', recommended: false, webgpu: true },
                        { type: 'bubble', icon: 'ü´ß', label: 'Bubble Chart', recommended: false }
                    );
                } else if (numCount === 1 && strCount === 1) {
                    // One numeric, one string
                    recommendations.push(
                        { type: 'bar', icon: '', label: 'Bar Chart', recommended: true },
                        { type: 'column', icon: '', label: 'Column Chart', recommended: true },
                        { type: 'area', icon: 'üèî', label: 'Area Chart', recommended: false }
                    );
                } else {
                    // Both string
                    recommendations.push(
                        { type: 'heatmap', icon: 'üî•', label: 'Heatmap', recommended: true },
                        { type: 'sankey', icon: 'üåä', label: 'Sankey Diagram', recommended: false }
                    );
                }
            }
            
            // Three columns - 3D SCATTER IS KING!
            else if (columns.length === 3) {
                if (numCount >= 2) {
                    recommendations.push(
                        { type: '3d-scatter', icon: '', label: '3D Scatter Plot', recommended: true, webgpu: true },
                        { type: 'bubble', icon: 'ü´ß', label: 'Bubble Chart (2D)', recommended: false }
                    );
                } else {
                    recommendations.push(
                        { type: 'grouped-bar', icon: '', label: 'Grouped Bar', recommended: true },
                        { type: 'treemap', icon: 'üó∫', label: 'Treemap', recommended: false }
                    );
                }
            }
            
            // 4+ columns
            else {
                recommendations.push(
                    { type: 'parallel', icon: '‚Äñ', label: 'Parallel Coordinates', recommended: true },
                    { type: 'radar', icon: 'üì°', label: 'Radar Chart', recommended: false },
                    { type: 'correlation', icon: 'üîó', label: 'Correlation Matrix', recommended: false, webgpu: true }
                );
            }

            return recommendations;
        }

        /**
         * Create visualization based on type
         */
        window.createVisualization = async function(type, columnNames) {
            // Remove menu
            const menu = document.getElementById('viz-menu');
            if (menu) menu.remove();

            console.log('Creating visualization:', type, columnNames);
            console.log('lastResults:', lastResults);

            if (!lastResults) {
                showNotification('No data to visualize. Please run a query first.', 'error');
                return;
            }

            // Handle different formats: Table object, { rows: [...] }, or direct array
            let data;
            if (lastResults.rows && Array.isArray(lastResults.rows)) {
                data = lastResults.rows;
            } else if (Array.isArray(lastResults)) {
                data = lastResults;
            } else {
                showNotification('Invalid data format', 'error');
                return;
            }
            
            if (!data || data.length === 0) {
                showNotification('No data available. Query returned empty results.', 'error');
                return;
            }

            console.log('========================================');
            console.log('CREATING VISUALIZATION');
            console.log('Type:', type);
            console.log('Columns:', columnNames);
            console.log('Total rows available:', data.length);
            console.log('Sample row:', data[0]);
            console.log('========================================');

            // Create modal with canvas
            const modal = createVisualizationModal(type, columnNames);
            document.body.appendChild(modal);

            // Render based on type
            try {
                switch (type) {
                    case '3d-scatter':
                        await render3DScatter(modal, data, columnNames);
                        break;
                    case 'scatter':
                    case '2d-scatter':
                        await render2DScatter(modal, data, columnNames);
                        break;
                    case 'line':
                        await render2DLine(modal, data, columnNames);
                        break;
                    case 'bar':
                    case 'column':
                        await render2DBar(modal, data, columnNames);
                        break;
                    case 'histogram':
                        await renderHistogram(modal, data, columnNames);
                        break;
                    case 'kpi':
                        await renderKPICard(modal, data, columnNames);
                        break;
                    default:
                        showNotification(`Visualization type "${type}" not yet implemented`, 'warn');
                        modal.remove();
                }
            } catch (error) {
                console.error('Visualization error:', error);
                showNotification(`Error creating visualization: ${error.message}`, 'error');
                modal.remove();
            }
        };

        /**
         * Create visualization modal
         */
        function createVisualizationModal(type, columnNames) {
            const modal = document.createElement('div');
            modal.className = 'viz-modal';
            modal.id = 'active-viz-modal';
            
            // Extract column names properly (handle {name: 'x', index: 0} objects or plain strings)
            const columnDisplayNames = columnNames.map(col => {
                if (typeof col === 'object' && col.name) {
                    return col.name;
                }
                return col;
            });
            
            modal.innerHTML = `
                <div class="viz-modal-content" style="width: 90vw; height: 90vh; display: flex; flex-direction: column;">
                    <div class="p-6 border-b border-white/10 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold outfit text-[#34B27B] glow-text">${getVizTitle(type)}</h2>
                            <p class="text-sm text-white/50 mono mt-1">${columnDisplayNames.join(' √ó ')}</p>
                        </div>
                        <button onclick="document.getElementById('active-viz-modal').remove()" 
                                class="text-white/50 hover:text-white text-2xl leading-none">‚úï</button>
                    </div>
                    <div class="flex-1 p-6 overflow-hidden flex items-center justify-center" style="background: #0a0a0a;">
                        <canvas id="viz-canvas" style="max-width: 100%; max-height: 100%;"></canvas>
                    </div>
                    <div class="p-4 border-t border-white/10 flex gap-4 items-center">
                        <div class="flex-1 flex gap-4" id="viz-controls"></div>
                        <button onclick="exportVisualization()" 
                                class="px-4 py-2 bg-[#34B27B]/20 hover:bg-[#34B27B]/30 rounded-lg text-sm transition-all">
                            Export PNG
                        </button>
                    </div>
                </div>
            `;

            return modal;
        }

        function getVizTitle(type) {
            const titles = {
                '3d-scatter': '3D Scatter Plot',
                'scatter': '‚ö´ 2D Scatter Plot',
                'line': 'üìà Line Chart',
                'bar': 'Bar Chart',
                'column': 'Column Chart',
                'histogram': 'Histogram',
                'kpi': 'üìà KPI Dashboard',
                'pie': 'ü•ß Pie Chart',
            };
            return titles[type] || 'Visualization';
        }

        /**
         * Render 3D Scatter Plot (WebGPU)
         */
        async function render3DScatter(modal, data, columns) {
            if (columns.length < 2) {
                throw new Error('Need at least 2 numeric columns for 3D scatter');
            }

            const canvas = modal.querySelector('#viz-canvas');
            
            // Set canvas size properly
            const container = canvas.parentElement;
            const width = container.clientWidth - 48;
            const height = container.clientHeight - 48;
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            console.log('3D Canvas size:', canvas.width, 'x', canvas.height);

            // Extract column names properly
            const xColName = columns[0]?.name || columns[0];
            const yColName = columns[1]?.name || columns[1];
            const zColName = columns[2]?.name || columns[2];
            const colorColName = columns[3]?.name || columns[3];

            // Add interactive controls
            const controlsDiv = modal.querySelector('#viz-controls');
            controlsDiv.innerHTML = `
                <div class="flex gap-4 items-center text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-white/50">X:</span>
                        <span class="text-[#34B27B] font-mono">${xColName}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-white/50">Y:</span>
                        <span class="text-[#34B27B] font-mono">${yColName}</span>
                    </div>
                    ${zColName ? `
                    <div class="flex items-center gap-2">
                        <span class="text-white/50">Z:</span>
                        <span class="text-[#34B27B] font-mono">${zColName}</span>
                    </div>` : ''}
                    <div class="flex items-center gap-2">
                        <span class="text-white/50">Points:</span>
                        <span class="text-[#34B27B] font-mono">${data.length.toLocaleString()}</span>
                    </div>
                </div>
            `;

            // Render using WebGPU
            let rotation = { x: 0, y: 0, z: 0 };
            
            const render = async () => {
                await webgpuViz.render3DScatter(canvas, data, {
                    xColumn: xColName,
                    yColumn: yColName,
                    zColumn: zColName || yColName,
                    colorColumn: colorColName,
                    rotation,
                    scale: 1.0
                });
            };

            await render();

            // Add rotation controls
            let isDragging = false;
            let lastX, lastY;

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            canvas.addEventListener('mousemove', async (e) => {
                if (!isDragging) return;

                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;

                rotation.y += deltaX * 0.01;
                rotation.x += deltaY * 0.01;

                lastX = e.clientX;
                lastY = e.clientY;

                await render();
            });

            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('mouseleave', () => isDragging = false);

            // Auto-rotate
            setInterval(async () => {
                if (!isDragging) {
                    rotation.y += 0.005;
                    await render();
                }
            }, 50);
        }

        /**
         * Render 2D Scatter Plot (WebGPU)
         */
        async function render2DScatter(modal, data, columns) {
            if (columns.length < 2) {
                throw new Error('Need 2 columns for scatter plot');
            }

            const canvas = modal.querySelector('#viz-canvas');
            
            // Set canvas size properly
            const container = canvas.parentElement;
            const width = container.clientWidth - 48; // Account for padding
            const height = container.clientHeight - 48;
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            console.log('Canvas size:', canvas.width, 'x', canvas.height);

            // Extract column names properly
            const xColName = columns[0]?.name || columns[0];
            const yColName = columns[1]?.name || columns[1];
            const colorColName = columns[2]?.name || columns[2];
            
            console.log('2D Scatter:', xColName, 'vs', yColName);

            try {
                await webgpuViz.render2DScatter(canvas, data, xColName, yColName, colorColName);
                
                const controlsDiv = modal.querySelector('#viz-controls');
                controlsDiv.innerHTML = `
                    <div class="text-sm flex gap-6">
                        <div><span class="text-white/50">X Axis:</span> <span class="text-[#34B27B]">${xColName}</span></div>
                        <div><span class="text-white/50">Y Axis:</span> <span class="text-[#34B27B]">${yColName}</span></div>
                        <div><span class="text-white/50">Points:</span> <span class="text-[#34B27B]">${data.length.toLocaleString()}</span></div>
                    </div>
                `;
                
                console.log(' 2D scatter rendered with', data.length, 'points');
            } catch (error) {
                console.error('Render error:', error);
                throw error;
            }
        }

        /**
         * Render 2D Line Chart (WebGPU)
         */
        async function render2DLine(modal, data, columns) {
            showNotification(' Line chart coming soon with WebGPU acceleration!', 'info');
        }

        /**
         * Render 2D Bar Chart
         */
        async function render2DBar(modal, data, columns) {
            const canvas = modal.querySelector('#viz-canvas');
            
            if (!columns || columns.length === 0) {
                throw new Error('Need at least 1 column for bar chart');
            }

            // Extract column names properly
            const xColumnName = columns[0]?.name || columns[0];
            const yColumnName = columns[1]?.name || columns[1];
            
            console.log(' Bar chart - X:', xColumnName, 'Y:', yColumnName);
            
            // If we have both X and Y, create grouped bar chart
            if (yColumnName && yColumnName !== xColumnName) {
                await renderGroupedBarChart(modal, data, xColumnName, yColumnName);
                return;
            }
            
            // Single column - count occurrences
            const counts = {};
            data.forEach(row => {
                const value = row[xColumnName];
                if (value !== undefined && value !== null) {
                    counts[value] = (counts[value] || 0) + 1;
                }
            });

            // Sort by count descending - show ALL values
            const sortedEntries = Object.entries(counts)
                .sort((a, b) => b[1] - a[1]);

            console.log(`Found ${sortedEntries.length} unique values in ${xColumnName}`);

            // Display as HTML bars instead of canvas with scrolling
            canvas.style.display = 'none';
            const container = canvas.parentElement;
            
            const maxCount = sortedEntries[0][1];
            
            container.innerHTML = `
                <div class="w-full max-w-6xl h-full overflow-y-auto pr-4" style="max-height: calc(90vh - 200px);">
                    <div class="space-y-3 pb-8">
                        ${sortedEntries.map(([value, count], index) => {
                            const percentage = (count / maxCount) * 100;
                            return `
                            <div class="flex items-center gap-4 hover:bg-white/5 p-2 rounded-lg transition-all">
                                <div class="w-8 text-right text-xs text-white/40">#${index + 1}</div>
                                <div class="w-40 text-right text-sm text-white/70 truncate font-mono" title="${value}">${value}</div>
                                <div class="flex-1 bg-white/5 rounded-lg overflow-hidden h-10 relative">
                                    <div class="bg-gradient-to-r from-[#34B27B] to-[#2a9463] h-full transition-all duration-500 flex items-center justify-end pr-4"
                                         style="width: ${percentage}%">
                                        <span class="text-white font-bold text-sm">${count.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="w-20 text-sm text-white/50 font-mono">${((count / data.length) * 100).toFixed(1)}%</div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            const controlsDiv = modal.querySelector('#viz-controls');
            controlsDiv.innerHTML = `
                <div class="text-sm flex gap-6">
                    <div><span class="text-white/50">Column:</span> <span class="text-[#34B27B]">${xColumnName}</span></div>
                    <div><span class="text-white/50">Unique values:</span> <span class="text-[#34B27B]">${sortedEntries.length.toLocaleString()}</span></div>
                    <div><span class="text-white/50">Total rows:</span> <span class="text-[#34B27B]">${data.length.toLocaleString()}</span></div>
                    <div><span class="text-white/50">Top value:</span> <span class="text-[#34B27B]">"${sortedEntries[0][0]}" (${sortedEntries[0][1]})</span></div>
                </div>
            `;
            
            console.log('Bar chart rendered with', sortedEntries.length, 'bars (all values shown)');
        }

        /**
         * Render Grouped Bar Chart (X category vs Y category)
         * Now handles ALL combinations intelligently!
         */
        async function renderGroupedBarChart(modal, data, xColumn, yColumn) {
            const canvas = modal.querySelector('#viz-canvas');
            const ctx = canvas.getContext('2d');
            
            console.log(`Bar chart: ${xColumn} vs ${yColumn}`);
            
            // Check data types
            const xType = columnDataTypes.get(xColumn);
            const yType = columnDataTypes.get(yColumn);
            const xIsNumeric = xType?.isNumeric || false;
            const yIsNumeric = yType?.isNumeric || false;
            
            console.log(`Types: X(${xColumn})=${xIsNumeric ? 'numeric' : 'categorical'}, Y(${yColumn})=${yIsNumeric ? 'numeric' : 'categorical'}`);
            
            // Smart handling of all 4 combinations
            if (!xIsNumeric && yIsNumeric) {
                // Perfect! X = categories, Y = numeric
                console.log('Ideal case: categorical X, numeric Y');
                await renderCategoryVsNumericBar(modal, data, xColumn, yColumn);
                return;
            }
            
            if (xIsNumeric && !yIsNumeric) {
                // Swap them! X should be categorical
                console.log('üîÑ Auto-swapping: X is numeric, Y is categorical');
                await renderCategoryVsNumericBar(modal, data, yColumn, xColumn);
                return;
            }
            
            if (xIsNumeric && yIsNumeric) {
                // Both numeric - treat X as categories, aggregate Y
                console.log('Both numeric: treating X as categories, aggregating Y');
                await renderCategoryVsNumericBar(modal, data, xColumn, yColumn);
                return;
            }
            
            // Both categorical - create frequency cross-tabulation
            console.log('Both categorical: creating frequency heatmap');
            await renderCategoricalCrossTab(modal, data, xColumn, yColumn);
        }
        
        /**
         * Render categorical cross-tabulation as grouped bars
         */
        async function renderCategoricalCrossTab(modal, data, xColumn, yColumn) {
            const canvas = modal.querySelector('#viz-canvas');
            
            console.log(`Cross-tab: ${xColumn} vs ${yColumn}`);
            
            // Build frequency table
            const crosstab = new Map();
            const yCategories = new Set();
            
            data.forEach(row => {
                const x = row[xColumn];
                const y = row[yColumn];
                
                if (x !== undefined && x !== null && y !== undefined && y !== null) {
                    yCategories.add(y);
                    
                    if (!crosstab.has(x)) {
                        crosstab.set(x, new Map());
                    }
                    const yMap = crosstab.get(x);
                    yMap.set(y, (yMap.get(y) || 0) + 1);
                }
            });
            
            // Sort X categories by total frequency, take top 30
            const xSorted = Array.from(crosstab.entries())
                .map(([x, yMap]) => {
                    const total = Array.from(yMap.values()).reduce((sum, count) => sum + count, 0);
                    return { x, yMap, total };
                })
                .sort((a, b) => b.total - a.total)
                .slice(0, 30);
            
            // Take top 10 Y categories by overall frequency
            const yCounts = new Map();
            yCategories.forEach(y => {
                let total = 0;
                xSorted.forEach(({ yMap }) => {
                    total += yMap.get(y) || 0;
                });
                yCounts.set(y, total);
            });
            
            const yArray = Array.from(yCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([y]) => y);
            
            console.log(`Showing ${xSorted.length} X categories √ó ${yArray.length} Y categories`);
            
            // Colors for Y categories
            const colors = [
                '#34B27B', '#4ECDC4', '#FF6B6B', '#FFA07A', 
                '#45B7D1', '#96CEB4', '#FFEAA7', '#DFE6E9',
                '#A29BFE', '#FD79A8'
            ];
            
            canvas.style.display = 'none';
            const container = canvas.parentElement;
            
            container.innerHTML = `
                <div class="w-full h-full overflow-y-auto pr-4" style="max-height: calc(90vh - 200px);">
                    <!-- Info banner -->
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                        <div class="text-blue-300 font-bold mb-2">ÔøΩ Categorical Cross-Tabulation</div>
                        <div class="text-white/70 text-sm">
                            Both columns are categorical. Showing frequency distribution: 
                            <span class="text-[#34B27B] font-bold">${xColumn}</span> (rows) √ó 
                            <span class="text-[#34B27B] font-bold">${yColumn}</span> (colors)
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex flex-wrap gap-3 mb-6 p-4 bg-white/5 rounded-lg sticky top-0 z-10 backdrop-blur-sm">
                        ${yArray.map((y, idx) => `
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded" style="background: ${colors[idx % colors.length]}"></div>
                                <span class="text-xs text-white/70 font-mono">${y}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Grouped bars -->
                    <div class="space-y-4 pb-8">
                        ${xSorted.map(({ x, yMap, total }) => {
                            return `
                            <div class="hover:bg-white/5 p-3 rounded-lg transition-all">
                                <div class="flex items-center mb-2">
                                    <div class="text-sm font-bold text-white/90 flex-1">${x}</div>
                                    <div class="text-xs text-white/40">${total} total</div>
                                </div>
                                <div class="flex gap-1 h-10">
                                    ${yArray.map((y, idx) => {
                                        const count = yMap.get(y) || 0;
                                        const width = total > 0 ? (count / total * 100) : 0;
                                        return `
                                        <div class="group relative" style="width: ${width}%; min-width: ${count > 0 ? '2%' : '0'}">
                                            <div class="h-full rounded flex items-center justify-center text-white font-bold text-xs transition-all hover:brightness-125"
                                                 style="background: ${colors[idx % colors.length]}">
                                                ${count > 0 ? count : ''}
                                            </div>
                                            ${count > 0 ? `
                                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-black/90 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-20">
                                                ${y}: ${count} (${width.toFixed(1)}%)
                                            </div>
                                            ` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            const controlsDiv = modal.querySelector('#viz-controls');
            controlsDiv.innerHTML = `
                <div class="text-sm flex gap-6">
                    <div><span class="text-white/50">X (Rows):</span> <span class="text-[#34B27B]">${xColumn}</span> (${xSorted.length} shown)</div>
                    <div><span class="text-white/50">Y (Groups):</span> <span class="text-[#34B27B]">${yColumn}</span> (${yArray.length} categories)</div>
                    <div><span class="text-white/50">Total rows:</span> <span class="text-[#34B27B]">${data.length.toLocaleString()}</span></div>
                </div>
            `;
            
            console.log('Categorical cross-tab rendered');
        }

        /**
         * Render proper bar chart with X=categories, Y=numeric values on axes
         */
        async function renderCategoryVsNumericBar(modal, data, xColumn, yColumn) {
            const canvas = modal.querySelector('#viz-canvas');
            
            console.log(`Bar chart: ${xColumn} (categories) vs ${yColumn} (numeric)`);
            
            // Aggregate numeric values by category
            const categoryStats = new Map();
            
            data.forEach(row => {
                const category = row[xColumn];
                const value = parseFloat(row[yColumn]);
                
                if (category !== undefined && category !== null && !isNaN(value)) {
                    if (!categoryStats.has(category)) {
                        categoryStats.set(category, { values: [], sum: 0, count: 0 });
                    }
                    const stats = categoryStats.get(category);
                    stats.values.push(value);
                    stats.sum += value;
                    stats.count += 1;
                }
            });
            
            // Calculate aggregations and sort by count (most frequent categories first)
            const aggregated = Array.from(categoryStats.entries())
                .map(([category, stats]) => ({
                    category,
                    count: stats.count,
                    sum: stats.sum,
                    avg: stats.sum / stats.count,
                    min: Math.min(...stats.values),
                    max: Math.max(...stats.values)
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 50); // Show top 50 categories
            
            console.log(`Aggregated ${categoryStats.size} categories, showing top ${aggregated.length}`);
            
            // Hide canvas, use HTML for better scrolling
            canvas.style.display = 'none';
            const container = canvas.parentElement;
            
            const maxAvg = Math.max(...aggregated.map(d => d.avg));
            
            container.innerHTML = `
                <div class="w-full h-full overflow-y-auto pr-4" style="max-height: calc(90vh - 200px);">
                    <!-- Aggregation selector -->
                    <div class="sticky top-0 bg-[#0a0a0a] z-10 pb-4 mb-4 border-b border-white/10">
                        <div class="flex gap-4 items-center">
                            <span class="text-white/70">Show:</span>
                            <div class="flex gap-2">
                                <button onclick="switchBarAggregation('avg')" 
                                        id="agg-avg" 
                                        class="px-3 py-1 rounded bg-[#34B27B] text-white text-sm font-bold">
                                    Average
                                </button>
                                <button onclick="switchBarAggregation('sum')" 
                                        id="agg-sum"
                                        class="px-3 py-1 rounded bg-white/10 text-white/70 text-sm hover:bg-white/20">
                                    Sum
                                </button>
                                <button onclick="switchBarAggregation('count')" 
                                        id="agg-count"
                                        class="px-3 py-1 rounded bg-white/10 text-white/70 text-sm hover:bg-white/20">
                                    Count
                                </button>
                                <button onclick="switchBarAggregation('min')" 
                                        id="agg-min"
                                        class="px-3 py-1 rounded bg-white/10 text-white/70 text-sm hover:bg-white/20">
                                    Min
                                </button>
                                <button onclick="switchBarAggregation('max')" 
                                        id="agg-max"
                                        class="px-3 py-1 rounded bg-white/10 text-white/70 text-sm hover:bg-white/20">
                                    Max
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="bar-chart-container" class="space-y-3 pb-8">
                        ${aggregated.map((item, index) => {
                            const percentage = (item.avg / maxAvg) * 100;
                            return `
                            <div class="bar-item flex items-center gap-4 hover:bg-white/5 p-2 rounded-lg transition-all"
                                 data-category="${item.category}"
                                 data-count="${item.count}"
                                 data-sum="${item.sum.toFixed(2)}"
                                 data-avg="${item.avg.toFixed(2)}"
                                 data-min="${item.min.toFixed(2)}"
                                 data-max="${item.max.toFixed(2)}">
                                <div class="w-8 text-right text-xs text-white/40">#${index + 1}</div>
                                <div class="w-48 text-right text-sm text-white/70 truncate font-mono" title="${item.category}">
                                    ${item.category}
                                </div>
                                <div class="flex-1 bg-white/5 rounded-lg overflow-hidden h-12 relative">
                                    <div class="bar-fill bg-gradient-to-r from-[#34B27B] to-[#2a9463] h-full transition-all duration-500 flex items-center justify-end pr-4"
                                         style="width: ${percentage}%">
                                        <span class="bar-value text-white font-bold text-sm">${item.avg.toFixed(1)}</span>
                                    </div>
                                </div>
                                <div class="w-32 text-sm text-white/50 font-mono">
                                    <div class="bar-details">
                                        <span class="text-white/70">${item.count}</span> items
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Store data for aggregation switching
            window.currentBarData = aggregated;
            window.currentBarXColumn = xColumn;
            window.currentBarYColumn = yColumn;
            
            const controlsDiv = modal.querySelector('#viz-controls');
            controlsDiv.innerHTML = `
                <div class="text-sm flex gap-6">
                    <div><span class="text-white/50">X Axis:</span> <span class="text-[#34B27B]">${xColumn}</span> (${aggregated.length} categories shown)</div>
                    <div><span class="text-white/50">Y Axis:</span> <span class="text-[#34B27B]">${yColumn}</span> (aggregated)</div>
                    <div><span class="text-white/50">Total data points:</span> <span class="text-[#34B27B]">${data.length.toLocaleString()}</span></div>
                </div>
            `;
            
            console.log('Aggregated bar chart rendered');
        }
        
        /**
         * Switch between different aggregations
         */
        window.switchBarAggregation = function(aggType) {
            const data = window.currentBarData;
            if (!data) return;
            
            // Update button states
            ['avg', 'sum', 'count', 'min', 'max'].forEach(type => {
                const btn = document.getElementById(`agg-${type}`);
                if (btn) {
                    if (type === aggType) {
                        btn.className = 'px-3 py-1 rounded bg-[#34B27B] text-white text-sm font-bold';
                    } else {
                        btn.className = 'px-3 py-1 rounded bg-white/10 text-white/70 text-sm hover:bg-white/20';
                    }
                }
            });
            
            // Sort data based on aggregation type
            const sorted = [...data].sort((a, b) => b[aggType] - a[aggType]);
            const maxValue = Math.max(...sorted.map(d => d[aggType]));
            
            // Update all bars
            document.querySelectorAll('.bar-item').forEach((item, index) => {
                const category = item.dataset.category;
                const itemData = sorted.find(d => d.category === category);
                if (!itemData) return;
                
                const value = itemData[aggType];
                const percentage = (value / maxValue) * 100;
                
                const fill = item.querySelector('.bar-fill');
                const valueSpan = item.querySelector('.bar-value');
                const details = item.querySelector('.bar-details');
                
                fill.style.width = `${percentage}%`;
                valueSpan.textContent = aggType === 'count' ? value : value.toFixed(1);
                
                // Update details text
                const labels = {
                    avg: `avg of ${itemData.count} items`,
                    sum: `sum of ${itemData.count} items`,
                    count: `${value} occurrences`,
                    min: `min of ${itemData.count} items`,
                    max: `max of ${itemData.count} items`
                };
                details.innerHTML = `<span class="text-white/70">${value.toFixed(aggType === 'count' ? 0 : 1)}</span> ${labels[aggType].split(' ').slice(1).join(' ')}`;
            });
            
            console.log(` Switched to ${aggType} aggregation`);
        };

        /**
         * Render Histogram (WebGPU)
         */
        async function renderHistogram(modal, data, columns) {
            const canvas = modal.querySelector('#viz-canvas');
            
            // Extract column name properly
            const column = columns[0]?.name || columns[0];
            
            console.log('Histogram for column:', column);
            
            // Get numeric values
            const values = data.map(d => parseFloat(d[column])).filter(v => !isNaN(v));
            
            if (values.length === 0) {
                showNotification('No numeric values found in column ' + column, 'error');
                modal.remove();
                return;
            }

            const min = Math.min(...values);
            const max = Math.max(...values);
            const numBins = 30;
            const binWidth = (max - min) / numBins;

            // Create bins
            const bins = Array(numBins).fill(0);
            values.forEach(v => {
                const binIndex = Math.min(Math.floor((v - min) / binWidth), numBins - 1);
                bins[binIndex]++;
            });

            const maxBinCount = Math.max(...bins);

            // Display as HTML bars
            canvas.style.display = 'none';
            const container = canvas.parentElement;
            
            container.innerHTML = `
                <div class="w-full max-w-6xl">
                    <div class="flex items-end gap-1 h-96 px-8">
                        ${bins.map((count, i) => {
                            const height = (count / maxBinCount) * 100;
                            const binStart = min + i * binWidth;
                            const binEnd = binStart + binWidth;
                            return `
                            <div class="flex-1 flex flex-col items-center justify-end group cursor-pointer">
                                <div class="w-full bg-gradient-to-t from-[#34B27B] to-[#4ecdc4] rounded-t transition-all hover:opacity-80"
                                     style="height: ${height}%"
                                     title="${binStart.toFixed(1)} - ${binEnd.toFixed(1)}: ${count} items">
                                </div>
                                <div class="text-[9px] text-white/30 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${count}
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="flex justify-between text-xs text-white/50 px-8 mt-4">
                        <span>${min.toFixed(1)}</span>
                        <span>${((min + max) / 2).toFixed(1)}</span>
                        <span>${max.toFixed(1)}</span>
                    </div>
                </div>
            `;

            const controlsDiv = modal.querySelector('#viz-controls');
            const stats = await computeStats(db, data, column);
            controlsDiv.innerHTML = `
                <div class="text-sm flex gap-6">
                    <div><span class="text-white/50">Range:</span> <span class="text-[#34B27B]">${min.toFixed(1)} - ${max.toFixed(1)}</span></div>
                    <div><span class="text-white/50">Mean:</span> <span class="text-[#34B27B]">${stats.avg.toFixed(2)}</span></div>
                    <div><span class="text-white/50">Median:</span> <span class="text-[#34B27B]">${stats.median.toFixed(2)}</span></div>
                    <div><span class="text-white/50">Bins:</span> <span class="text-[#34B27B]">${numBins}</span></div>
                </div>
            `;
            
            console.log('Histogram rendered');
        }

        /**
         * Render KPI Card (WebGPU compute shaders)
         */
        async function renderKPICard(modal, data, columns) {
            const canvas = modal.querySelector('#viz-canvas');
            
            // Extract column name properly
            const column = columns[0]?.name || columns[0];
            
            console.log(' KPI Card for column:', column);
            
            // Compute stats using GPU
            const stats = await computeStats(db, data, column);

            // Display as HTML instead of canvas
            canvas.style.display = 'none';
            const container = canvas.parentElement;
            
            container.innerHTML = `
                <div class="grid grid-cols-3 gap-6 max-w-6xl w-full">
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Minimum</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.min.toLocaleString()}</div>
                    </div>
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Maximum</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.max.toLocaleString()}</div>
                    </div>
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Average</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.avg.toFixed(2)}</div>
                    </div>
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Median</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.median.toFixed(2)}</div>
                    </div>
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Std Dev</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.stdDev.toFixed(2)}</div>
                    </div>
                    <div class="bg-[#11181C] rounded-xl border border-white/10 p-8 hover:border-[#34B27B]/30 transition-all">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-2">Count</div>
                        <div class="text-4xl font-bold outfit text-[#34B27B] glow-text">${stats.count.toLocaleString()}</div>
                    </div>
                    <div class="col-span-3 bg-[#11181C] rounded-xl border border-white/10 p-8">
                        <div class="text-sm text-white/50 uppercase tracking-wider mb-4">Range</div>
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <div class="h-3 bg-gradient-to-r from-[#34B27B]/20 via-[#34B27B]/40 to-[#34B27B]/20 rounded-full relative">
                                    <div class="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-4 bg-[#34B27B] rounded-full shadow-lg shadow-[#34B27B]/50"></div>
                                    <div class="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 bg-[#34B27B] rounded-full shadow-lg shadow-[#34B27B]/50"></div>
                                </div>
                            </div>
                            <div class="text-2xl font-bold text-[#34B27B] mono">${(stats.max - stats.min).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;

            modal.querySelector('#viz-controls').innerHTML = `
                <div class="text-sm text-white/50">
                    Analyzed ${column} ‚Ä¢ ${stats.count.toLocaleString()} values
                </div>
            `;
        }

        /**
         * Export visualization
         */
        window.exportVisualization = function() {
            const canvas = document.getElementById('viz-canvas');
            if (!canvas) return;

            const link = document.createElement('a');
            link.download = `griddb-viz-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showNotification(' Visualization exported!', 'success');
        };

        // Initialize on load
        init();
    </script>
</body>
</html>